function ExchangeManager(a,b,c,d,e,f){var g=this;void 0===e.iceServers&&(e.iceServers=[{url:"stun:stun.l.google.com:19302"}]),void 0===e.protocol&&(e.protocol={offer:"OFFER",answer:"ANSWER",candidate:"CANDIDATE",port:"PORT"}),this.protocol=e.protocol,this._options=e,this.path=c,this._send=function(a){console.log(f),d.emit(a,b,g.path,f)},this.id=a,this.peer=b,this.pc=null,this.exchange=d,this.labels={},this._default=0,this.id&&this.initialize()}function md5cycle(a,b){var c=a[0],d=a[1],e=a[2],f=a[3];c=ff(c,d,e,f,b[0],7,-680876936),f=ff(f,c,d,e,b[1],12,-389564586),e=ff(e,f,c,d,b[2],17,606105819),d=ff(d,e,f,c,b[3],22,-1044525330),c=ff(c,d,e,f,b[4],7,-176418897),f=ff(f,c,d,e,b[5],12,1200080426),e=ff(e,f,c,d,b[6],17,-1473231341),d=ff(d,e,f,c,b[7],22,-45705983),c=ff(c,d,e,f,b[8],7,1770035416),f=ff(f,c,d,e,b[9],12,-1958414417),e=ff(e,f,c,d,b[10],17,-42063),d=ff(d,e,f,c,b[11],22,-1990404162),c=ff(c,d,e,f,b[12],7,1804603682),f=ff(f,c,d,e,b[13],12,-40341101),e=ff(e,f,c,d,b[14],17,-1502002290),d=ff(d,e,f,c,b[15],22,1236535329),c=gg(c,d,e,f,b[1],5,-165796510),f=gg(f,c,d,e,b[6],9,-1069501632),e=gg(e,f,c,d,b[11],14,643717713),d=gg(d,e,f,c,b[0],20,-373897302),c=gg(c,d,e,f,b[5],5,-701558691),f=gg(f,c,d,e,b[10],9,38016083),e=gg(e,f,c,d,b[15],14,-660478335),d=gg(d,e,f,c,b[4],20,-405537848),c=gg(c,d,e,f,b[9],5,568446438),f=gg(f,c,d,e,b[14],9,-1019803690),e=gg(e,f,c,d,b[3],14,-187363961),d=gg(d,e,f,c,b[8],20,1163531501),c=gg(c,d,e,f,b[13],5,-1444681467),f=gg(f,c,d,e,b[2],9,-51403784),e=gg(e,f,c,d,b[7],14,1735328473),d=gg(d,e,f,c,b[12],20,-1926607734),c=hh(c,d,e,f,b[5],4,-378558),f=hh(f,c,d,e,b[8],11,-2022574463),e=hh(e,f,c,d,b[11],16,1839030562),d=hh(d,e,f,c,b[14],23,-35309556),c=hh(c,d,e,f,b[1],4,-1530992060),f=hh(f,c,d,e,b[4],11,1272893353),e=hh(e,f,c,d,b[7],16,-155497632),d=hh(d,e,f,c,b[10],23,-1094730640),c=hh(c,d,e,f,b[13],4,681279174),f=hh(f,c,d,e,b[0],11,-358537222),e=hh(e,f,c,d,b[3],16,-722521979),d=hh(d,e,f,c,b[6],23,76029189),c=hh(c,d,e,f,b[9],4,-640364487),f=hh(f,c,d,e,b[12],11,-421815835),e=hh(e,f,c,d,b[15],16,530742520),d=hh(d,e,f,c,b[2],23,-995338651),c=ii(c,d,e,f,b[0],6,-198630844),f=ii(f,c,d,e,b[7],10,1126891415),e=ii(e,f,c,d,b[14],15,-1416354905),d=ii(d,e,f,c,b[5],21,-57434055),c=ii(c,d,e,f,b[12],6,1700485571),f=ii(f,c,d,e,b[3],10,-1894986606),e=ii(e,f,c,d,b[10],15,-1051523),d=ii(d,e,f,c,b[1],21,-2054922799),c=ii(c,d,e,f,b[8],6,1873313359),f=ii(f,c,d,e,b[15],10,-30611744),e=ii(e,f,c,d,b[6],15,-1560198380),d=ii(d,e,f,c,b[13],21,1309151649),c=ii(c,d,e,f,b[4],6,-145523070),f=ii(f,c,d,e,b[11],10,-1120210379),e=ii(e,f,c,d,b[2],15,718787259),d=ii(d,e,f,c,b[9],21,-343485551),a[0]=add32(c,a[0]),a[1]=add32(d,a[1]),a[2]=add32(e,a[2]),a[3]=add32(f,a[3])}function cmn(a,b,c,d,e,f){return b=add32(add32(b,a),add32(d,f)),add32(b<<e|b>>>32-e,c)}function ff(a,b,c,d,e,f,g){return cmn(b&c|~b&d,a,b,e,f,g)}function gg(a,b,c,d,e,f,g){return cmn(b&d|c&~d,a,b,e,f,g)}function hh(a,b,c,d,e,f,g){return cmn(b^c^d,a,b,e,f,g)}function ii(a,b,c,d,e,f,g){return cmn(c^(b|~d),a,b,e,f,g)}function md51(a){txt="";var b,c=a.length,d=[1732584193,-271733879,-1732584194,271733878];for(b=64;b<=a.length;b+=64)md5cycle(d,md5blk(a.substring(b-64,b)));a=a.substring(b-64);var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(b=0;b<a.length;b++)e[b>>2]|=a.charCodeAt(b)<<(b%4<<3);if(e[b>>2]|=128<<(b%4<<3),b>55)for(md5cycle(d,e),b=0;16>b;b++)e[b]=0;return e[14]=8*c,md5cycle(d,e),d}function md5blk(a){var b,c=[];for(b=0;64>b;b+=4)c[b>>2]=a.charCodeAt(b)+(a.charCodeAt(b+1)<<8)+(a.charCodeAt(b+2)<<16)+(a.charCodeAt(b+3)<<24);return c}function rhex(a){for(var b="",c=0;4>c;c++)b+=hex_chr[15&a>>8*c+4]+hex_chr[15&a>>8*c];return b}function hex(a){for(var b=0;b<a.length;b++)a[b]=rhex(a[b]);return a.join("")}function md5(a){return hex(md51(a))}function add32(a,b){return 4294967295&a+b}function add32(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}var Exchange=function(a){var b=this;if(this.id=a,this.managers={},arguments.length>2){this.connections=arguments[2];for(var c in this.connections)this.addDC(this.connections[c],c)}else this.connections={};this.events={peer:new Array,peers:new Array},this.servers=[],this.queue=[],this.messages={},this.queueInterval=setInterval(b.dequeue.bind(this),250)};Exchange.prototype.handleBinary=function(a){void 0===this.messages[a.hash]&&(this.messages[a.hash]=new Array(a.length)),this.messages[a.hash][a.start]=a.part,console.log(this.messages),md5(this.messages[a.hash].join(""))==a.hash&&this.ondata(JSON.parse(this.messages[a.hash].join("")))},Exchange.prototype._send=function(a,b){for(var c=this,a=JSON.stringify(a),d=md5(a),e=[],f=0;f<a.length;f+=512){var g=a.substr(f,512);e.push(g)}for(var f=0;f<e.length;f++){var h={exchange:!0,start:f,part:e[f],hash:d,length:e.length};c.queue.push({peer:b,packet:JSON.stringify(h)})}},Exchange.prototype.enqueue=function(a,b){this.queue.push({peer:b,packet:a})},Exchange.prototype.dequeue=function(){var a=this;if(this.queue.length>0){var b=this.queue.shift();a.connections[b.peer].send(b.packet)}},Exchange.prototype.addDC=function(a,b){var c=this,d=a.onmessage,e=a.onerror;a.onmessage=function(a){var b=a.data;console.log("got",a);try{b=JSON.parse(b)}catch(e){if("function"!=typeof d)throw e;d(a)}console.log(b),void 0!==b.exchange?c.handleBinary(b):"function"==typeof d&&d(a)},a.onerror=function(a){console.log("ERROR: ",a),"function"==typeof e&&e(a)},c.connections[b]=a},Exchange.prototype.initWS=function(a,b){var c=this;return ws=new WebSocket(a),ws.onmessage=function(a){console.log(a);var d=JSON.parse(a.data);void 0!==d.peers?c.trigger("peers",d.peers):(console.log(d),{to:d[b.to],from:d[b.from],path:[],type:d[b.type],payload:d[b.payload],protocol:b},d.type!=b.ignore&&c.ondata(JSON.parse(a.data)))},ws.onclose=function(){},this.servers.push({socket:ws,protocol:b}),ws},Exchange.prototype.ondata=function(a){console.log("handeling",a),a.to!=this.id?this.forward(a):(-1==a.path.indexOf(this.id)&&a.path.push(this.id),void 0===this.managers[a.from]&&(this.managers[a.from]={}),void 0!==this.managers[a.from][a.label]?(console.log("our type",a.payload.type),this.managers[a.from][a.label].ondata(a.payload,a.path)):(console.log("our type",a.payload.type),console.log(this.id+" creating new manager for "+a.from),console.log("with label"+a.label),this.managers[a.from][a.label]=new ExchangeManager(this.id,a.from,a.path.reverse(),this,{},a.label),this.managers[a.from][a.label].ondata(a.payload),this.trigger("peer",this.managers[a.from][a.label])))},Exchange.prototype.forward=function(a){if(console.log("forwarding: ",a),void 0!==this.connections[a.to])-1==a.path.indexOf(this.id)&&a.path.push(this.id),this._send(a,a.to);else if(a.path.indexOf(this.id)+1==a.path.length||-1==a.path.indexOf(this.id)){-1==a.path.indexOf(this.id)&&a.path.push(this.id);for(var b in this.connections)-1==a.path.indexOf(b)&&this._send(a,b)}else if(a.path.indexOf(this.id)>-1){var c=a.path[a.path.indexOf(this.id)+1];console.log(c),this._send(a,c)}},Exchange.prototype.reliable=function(a,b,c,d,e){var f={path:c,from:this.id,to:d,payload:a,label:e};this._send(f,b)},Exchange.prototype.emit=function(a,b,c,d){if(console.log("emit",a.type),c.indexOf(b)+1==c.length&&-1==c.indexOf(this.id)&&c.unshift(this.id),void 0!==this.connections[b])-1==c.indexOf(this.id)&&c.push(this.id),console.log("emit",a.type),this.reliable(a,b,c,b,d);else if(c.indexOf(this.id)+1==c.length||-1==c.indexOf(this.id)){-1==c.indexOf(this.id)&&c.push(this.id);for(var e in this.connections)console.log(this.connections),-1==c.indexOf(e)&&this.reliable(a,e,[],b,d);for(var f=0;f<this.servers.length;f++){var g=this.servers[f];if(1==g.socket.readyState){var h={};h[g.protocol.to]=b,h[g.protocol.from]=this.id,h.path=[],h.label=d,h.payload=a,g.socket.send(JSON.stringify(h))}}}else if(c.indexOf(this.id)>-1){var i=c.indexOf(this.id)+1;this.reliable(a,c[i],c,b,d)}},Exchange.prototype.on=function(a,b){try{this.events[a].push(b)}catch(c){throw{message:a+" event doesn't exists",name:"EventException"}}},Exchange.prototype.trigger=function(a){for(var b in this.events[a])this.events[a][b].apply(this,arguments)},Exchange.prototype.connect=function(a,b){return console.log("connecting to ",a),void 0==b&&(b="base"),void 0===this.managers[a]&&(this.managers[a]={}),console.log("label ",b),this.managers[a][b]=new ExchangeManager(this.id,a,[],this,{},b),this.managers[a][b]};var RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection;ExchangeManager.prototype.ondata=function(a,b){var c=this;switch(void 0!==b&&(this.path=b.reverse()),a.type){case this.protocol.offer:console.log("got offer"),c._setupIce(),c.update(a.payload.labels),c.handleSDP(a.payload.sdp,a.type);break;case this.protocol.answer:console.log("got answer"),this.handleSDP(a.payload.sdp,a.type);break;case this.protocol.candidate:this.handleCandidate(a.payload,a.type);break;case this.protocol.port:this.handlePort(a.payload);break;default:console.log("got data I didn't know what to do with: ",a)}},ExchangeManager.prototype.initialize=function(a){a&&(this.id=a),this._startPeerConnection(),this._setupIce(),this._setupNegotiationHandler(),this.initialize=function(){}},ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC"),this.pc=new RTCPeerConnection(this._options,{optional:[{RtpDataChannels:!0}]})},ExchangeManager.prototype._setupIce=function(){var a=this;console.log("setting up ICE"),this.pc.onicecandidate=function(b){b.candidate&&(console.log(b.candidate),a._send({type:"CANDIDATE",payload:{candidate:b.candidate}}))}},ExchangeManager.prototype._makeAnswer=function(){var a=this;this.pc.createAnswer(function(b){console.log("Created answer."),a.pc.setLocalDescription(b,function(){console.log("Set localDescription to answer."),a._send({type:"ANSWER",payload:{sdp:b}})},function(a){console.log("Failed to setLocalDescription from PEX, ",a)})},function(a){console.log("Failed to create answer, ",a)})},ExchangeManager.prototype._setupNegotiationHandler=function(){var a=this;console.log("Listening for `negotiationneeded`"),this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered"),a._makeOffer()}},ExchangeManager.prototype._makeOffer=function(){var a=this;this.pc.createOffer(function(b){a.pc.setLocalDescription(b,function(){console.log("Set localDescription to offer"),console.log("Created offer."),a._send({type:"OFFER",payload:{sdp:b,config:a._options.config,labels:a.labels}}),a.labels={}},function(a){console.log("Failed to setLocalDescription, ",a)})})},ExchangeManager.prototype.handlePort=function(a){console.log("Received ports, calling connectDataConnection."),ExchangeManager.usedPorts||(ExchangeManager.usedPorts=[]),ExchangeManager.usedPorts.push(a.local),ExchangeManager.usedPorts.push(a.remote),this.pc.connectDataConnection(a.local,a.remote)},ExchangeManager.prototype.handleSDP=function(a,b){console.log("got "+b),a=new RTCSessionDescription(a),console.log(a);var c=this;this.pc.setRemoteDescription(a,function(){console.log("Set remoteDescription: "+b),"OFFER"===b&&c._makeAnswer()},function(a){console.log("Failed to setRemoteDescription, ",a)})},ExchangeManager.prototype.handleCandidate=function(a){console.log(a);var b=new RTCIceCandidate(a.candidate);this.pc.addIceCandidate(b),console.log("Added ICE candidate.")},ExchangeManager.prototype.update=function(a){for(var b=Object.keys(a),c=0,d=b.length;d>c;c+=1){var e=b[c];this.labels[e]=a[e]}};var hex_chr="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=md5("hello");