var Exchange=function(id,onpeerconnection){var self=this;this.id=id;this.onpeerconnection=onpeerconnection;this.managers={};if(arguments.length>2){this.connections=arguments[2];for(var peer in this.connections){this.addDC(this.connections[peer],peer)}}else{this.connections={}}this.servers=[];this.messages={};this._send=function(message,peer){try{if(self.connections[peer].readyState=="open"){self.connections[peer].send(message)}}catch(e){console.log(e)}}};Exchange.prototype.addDC=function(dc,peer){var self=this;var datacallback=dc.onmessage;var errorcallback=dc.onerror;dc.onmessage=function(e){var data=e.data;var keepParsing=true;while(keepParsing){try{data=JSON.parse(data)}catch(error){keepParsing=false}}if(data.exchange!==undefined){self.ondata(data)}else{if(typeof datacallback==="function"){datacallback(e)}}};dc.onerror=function(e){console.log("ERROR: ",e);if(typeof errorcallback==="function"){errorcallback(e)}};self.connections[peer]=dc};Exchange.prototype.initWS=function(ws,protocol){var self=this;ws.onmessage=function(e){console.log(e);var initialData=JSON.parse(e.data);console.log(initialData);var data={to:initialData[protocol.to],from:initialData[protocol.from],path:[],type:initialData[protocol.type],payload:initialData[protocol.payload],protocol:protocol};if(initialData.type!=protocol.ignore){self.ondata(data)}};ws.onclose=function(e){};this.servers.push({socket:ws,protocol:protocol})};Exchange.prototype.ondata=function(data){if(data.to!=this.id){this.forward(data)}else if(data.type=="reliable"){this.handleReliable(data)}else{if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}if(this.managers[data.from]!==undefined){this.managers[data.from].ondata(data,data.path)}else{this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{},this.onpeerconnection);this.managers[data.from].ondata(data)}}};Exchange.prototype.forward=function(data){console.log("forwarding: ",data);if(this.connections[data.to]!==undefined){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}this._send(JSON.stringify(data),data.to)}else if(data.path.indexOf(this.id)+1==data.path.length||data.path.indexOf(this.id)==-1){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}for(var peer in this.connections){if(data.path.indexOf(peer)==-1){this._send(JSON.stringify(data),peer)}}}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer);this._send(JSON.stringify(data),nextPeer)}};Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hash")){if(data.hasOwnProperty("count")){this.messages[data.hash]=[];console.log(parseInt(data.count));for(var i=0;i<parseInt(data.count);i++){this.messages[data.hash][i]=false}console.log("setting up messages");console.log(this.messages)}if(data.hasOwnProperty("data")){console.log(parseInt(data.key));console.log(this.messages);this.messages[data.hash][parseInt(data.key)]=data.data}var ready=true;for(var i=0;i<this.messages[data.hash].length;i++){ready=ready&&this.messages[data.hash][i]}if(ready){var newdata="";for(var i=0;i<this.messages[data.hash].length;i++){newdata+=this.messages[data.hash][i]}this.messages[data.hash]=null;delete this.messages[data.hash];console.log(newdata);newdata=JSON.parse(newdata);newdata.path=data.path;newdata.from=data.from;newdata.to=data.to;this.ondata(newdata)}}};Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);var self=this;var parts=[];var hash=md5(string);console.log(hash);for(var i=0;i<string.length;i+=512){var str=string.substr(i,512);parts.push(str)}var partsPacket={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,count:parts.length};this._send(JSON.stringify(partsPacket),peer);for(var key in parts){var part={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,key:key,data:parts[key]};this._send(JSON.stringify(part),peer)}};Exchange.prototype.emit=function(data,to,path){if(path.indexOf(to)+1==path.length&&path.indexOf(this.id)==-1){path.unshift(this.id)}if(this.connections[to]!==undefined){if(path.indexOf(this.id)==-1){path.push(this.id)}this.reliable(JSON.stringify(data),to,path,to)}else if(path.indexOf(this.id)+1==path.length||path.indexOf(this.id)==-1){if(path.indexOf(this.id)==-1){path.push(this.id)}for(var peer in this.connections){if(path.indexOf(peer)==-1){this.reliable(JSON.stringify(data),peer,[],to)}}for(var i=0;i<this.servers.length;i++){var server=this.servers[i];if(server.socket.readyState==1){var serverData={};serverData[server.protocol.to]=to;serverData[server.protocol.from]=this.id;serverData[server.protocol.type]=data.type;serverData[server.protocol.payload]=data.payload;server.socket.send(JSON.stringify(serverData))}}}else if(path.indexOf(this.id)>-1){var nextPeer=path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),path[nextPeer],path,to)}};Exchange.prototype.connect=function(peer){console.log("connecting to ",peer);this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{},this.onpeerconnection);return this.managers[peer]};var Exchange=function(id,onpeerconnection){var self=this;this.id=id;this.onpeerconnection=onpeerconnection;this.managers={};if(arguments.length>2){this.connections=arguments[2];for(var peer in this.connections){this.addDC(this.connections[peer],peer)}}else{this.connections={}}this.servers=[];this.messages={};this._send=function(message,peer){try{if(self.connections[peer].readyState=="open"){self.connections[peer].send(message)}}catch(e){console.log(e)}}};Exchange.prototype.addDC=function(dc,peer){var self=this;var datacallback=dc.onmessage;var errorcallback=dc.onerror;dc.onmessage=function(e){var data=e.data;var keepParsing=true;while(keepParsing){try{data=JSON.parse(data)}catch(error){keepParsing=false}}if(data.exchange!==undefined){self.ondata(data)}else{if(typeof datacallback==="function"){datacallback(e)}}};dc.onerror=function(e){console.log("ERROR: ",e);if(typeof errorcallback==="function"){errorcallback(e)}};self.connections[peer]=dc};Exchange.prototype.initWS=function(ws,protocol){var self=this;ws.onmessage=function(e){console.log(e);var initialData=JSON.parse(e.data);console.log(initialData);var data={to:initialData[protocol.to],from:initialData[protocol.from],path:[],type:initialData[protocol.type],payload:initialData[protocol.payload],protocol:protocol};if(initialData.type!=protocol.ignore){self.ondata(data)}};ws.onclose=function(e){};this.servers.push({socket:ws,protocol:protocol})};Exchange.prototype.ondata=function(data){if(data.to!=this.id){this.forward(data)}else if(data.type=="reliable"){this.handleReliable(data)}else{if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}if(this.managers[data.from]!==undefined){this.managers[data.from].ondata(data,data.path)}else{this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{},this.onpeerconnection);this.managers[data.from].ondata(data)}}};Exchange.prototype.forward=function(data){console.log("forwarding: ",data);if(this.connections[data.to]!==undefined){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}this._send(JSON.stringify(data),data.to)}else if(data.path.indexOf(this.id)+1==data.path.length||data.path.indexOf(this.id)==-1){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}for(var peer in this.connections){if(data.path.indexOf(peer)==-1){this._send(JSON.stringify(data),peer)}}}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer);this._send(JSON.stringify(data),nextPeer)}};Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hash")){if(data.hasOwnProperty("count")){this.messages[data.hash]=[];console.log(parseInt(data.count));for(var i=0;i<parseInt(data.count);i++){this.messages[data.hash][i]=false}console.log("setting up messages");console.log(this.messages)}if(data.hasOwnProperty("data")){console.log(parseInt(data.key));console.log(this.messages);this.messages[data.hash][parseInt(data.key)]=data.data}var ready=true;for(var i=0;i<this.messages[data.hash].length;i++){ready=ready&&this.messages[data.hash][i]}if(ready){var newdata="";for(var i=0;i<this.messages[data.hash].length;i++){newdata+=this.messages[data.hash][i]}this.messages[data.hash]=null;delete this.messages[data.hash];console.log(newdata);newdata=JSON.parse(newdata);newdata.path=data.path;newdata.from=data.from;newdata.to=data.to;this.ondata(newdata)}}};Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);var self=this;var parts=[];var hash=md5(string);console.log(hash);for(var i=0;i<string.length;i+=512){var str=string.substr(i,512);parts.push(str)}var partsPacket={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,count:parts.length};this._send(JSON.stringify(partsPacket),peer);for(var key in parts){var part={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,key:key,data:parts[key]};this._send(JSON.stringify(part),peer)}};Exchange.prototype.emit=function(data,to,path){if(path.indexOf(to)+1==path.length&&path.indexOf(this.id)==-1){path.unshift(this.id)}if(this.connections[to]!==undefined){if(path.indexOf(this.id)==-1){path.push(this.id)}this.reliable(JSON.stringify(data),to,path,to)}else if(path.indexOf(this.id)+1==path.length||path.indexOf(this.id)==-1){if(path.indexOf(this.id)==-1){path.push(this.id)}for(var peer in this.connections){if(path.indexOf(peer)==-1){this.reliable(JSON.stringify(data),peer,[],to)}}for(var i=0;i<this.servers.length;i++){var server=this.servers[i];if(server.socket.readyState==1){var serverData={};serverData[server.protocol.to]=to;serverData[server.protocol.from]=this.id;serverData[server.protocol.type]=data.type;serverData[server.protocol.payload]=data.payload;server.socket.send(JSON.stringify(serverData))}}}else if(path.indexOf(this.id)>-1){var nextPeer=path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),path[nextPeer],path,to)}};Exchange.prototype.connect=function(peer){console.log("connecting to ",peer);this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{},this.onpeerconnection);return this.managers[peer]};var Exchange=function(id,onpeerconnection){var self=this;this.id=id;this.onpeerconnection=onpeerconnection;this.managers={};if(arguments.length>2){this.connections=arguments[2];for(var peer in this.connections){this.addDC(this.connections[peer],peer)}}else{this.connections={}}this.servers=[];this.messages={};this._send=function(message,peer){try{if(self.connections[peer].readyState=="open"){self.connections[peer].send(message)}}catch(e){console.log(e)}}};Exchange.prototype.addDC=function(dc,peer){var self=this;var datacallback=dc.onmessage;var errorcallback=dc.onerror;dc.onmessage=function(e){var data=e.data;var keepParsing=true;while(keepParsing){try{data=JSON.parse(data)}catch(error){keepParsing=false}}if(data.exchange!==undefined){self.ondata(data)}else{if(typeof datacallback==="function"){datacallback(e)}}};dc.onerror=function(e){console.log("ERROR: ",e);if(typeof errorcallback==="function"){errorcallback(e)}};self.connections[peer]=dc};Exchange.prototype.initWS=function(ws,protocol){var self=this;ws.onmessage=function(e){console.log(e);var initialData=JSON.parse(e.data);console.log(initialData);var data={to:initialData[protocol.to],from:initialData[protocol.from],path:[],type:initialData[protocol.type],payload:initialData[protocol.payload],protocol:protocol};if(initialData.type!=protocol.ignore){self.ondata(data)}};ws.onclose=function(e){};this.servers.push({socket:ws,protocol:protocol})};Exchange.prototype.ondata=function(data){if(data.to!=this.id){this.forward(data)}else if(data.type=="reliable"){this.handleReliable(data)}else{if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}if(this.managers[data.from]!==undefined){this.managers[data.from].ondata(data,data.path)}else{this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{},this.onpeerconnection);this.managers[data.from].ondata(data)}}};Exchange.prototype.forward=function(data){console.log("forwarding: ",data);if(this.connections[data.to]!==undefined){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}this._send(JSON.stringify(data),data.to)}else if(data.path.indexOf(this.id)+1==data.path.length||data.path.indexOf(this.id)==-1){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}for(var peer in this.connections){if(data.path.indexOf(peer)==-1){this._send(JSON.stringify(data),peer)}}}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer);this._send(JSON.stringify(data),nextPeer)}};Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hash")){if(data.hasOwnProperty("count")){this.messages[data.hash]=[];console.log(parseInt(data.count));for(var i=0;i<parseInt(data.count);i++){this.messages[data.hash][i]=false}console.log("setting up messages");console.log(this.messages)}if(data.hasOwnProperty("data")){console.log(parseInt(data.key));console.log(this.messages);this.messages[data.hash][parseInt(data.key)]=data.data}var ready=true;for(var i=0;i<this.messages[data.hash].length;i++){ready=ready&&this.messages[data.hash][i]}if(ready){var newdata="";for(var i=0;i<this.messages[data.hash].length;i++){newdata+=this.messages[data.hash][i]}this.messages[data.hash]=null;delete this.messages[data.hash];console.log(newdata);newdata=JSON.parse(newdata);newdata.path=data.path;newdata.from=data.from;newdata.to=data.to;this.ondata(newdata)}}};Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);var self=this;var parts=[];var hash=md5(string);console.log(hash);for(var i=0;i<string.length;i+=512){var str=string.substr(i,512);parts.push(str)}var partsPacket={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,count:parts.length};this._send(JSON.stringify(partsPacket),peer);for(var key in parts){var part={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,key:key,data:parts[key]};this._send(JSON.stringify(part),peer)}};Exchange.prototype.emit=function(data,to,path){if(path.indexOf(to)+1==path.length&&path.indexOf(this.id)==-1){path.unshift(this.id)}if(this.connections[to]!==undefined){if(path.indexOf(this.id)==-1){path.push(this.id)}this.reliable(JSON.stringify(data),to,path,to)}else if(path.indexOf(this.id)+1==path.length||path.indexOf(this.id)==-1){if(path.indexOf(this.id)==-1){path.push(this.id)}for(var peer in this.connections){if(path.indexOf(peer)==-1){this.reliable(JSON.stringify(data),peer,[],to)}}for(var i=0;i<this.servers.length;i++){var server=this.servers[i];if(server.socket.readyState==1){var serverData={};serverData[server.protocol.to]=to;serverData[server.protocol.from]=this.id;serverData[server.protocol.type]=data.type;serverData[server.protocol.payload]=data.payload;server.socket.send(JSON.stringify(serverData))}}}else if(path.indexOf(this.id)>-1){var nextPeer=path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),path[nextPeer],path,to)}};Exchange.prototype.connect=function(peer){console.log("connecting to ",peer);this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{},this.onpeerconnection);return this.managers[peer]};var Exchange=function(id,onpeerconnection){var self=this;this.id=id;this.onpeerconnection=onpeerconnection;this.managers={};if(arguments.length>2){this.connections=arguments[2];for(var peer in this.connections){this.addDC(this.connections[peer],peer)}}else{this.connections={}}this.servers=[];this.messages={};this._send=function(message,peer){try{if(self.connections[peer].readyState=="open"){self.connections[peer].send(message)}}catch(e){console.log(e)}}};Exchange.prototype.addDC=function(dc,peer){var self=this;var datacallback=dc.onmessage;dc.onmessage=function(e){console.log(e);var data=e.data;var keepParsing=true;while(keepParsing){try{data=JSON.parse(data)}catch(error){keepParsing=false}}if(data.exchange!==undefined){self.ondata(data)}else{datacallback(e)}};self.connections[peer]=dc};Exchange.prototype.initWS=function(ws,protocol){var self=this;ws.onmessage=function(e){console.log(e);var initialData=JSON.parse(e.data);console.log(initialData);var data={to:initialData[protocol.to],from:initialData[protocol.from],path:[],type:initialData[protocol.type],payload:initialData[protocol.payload],protocol:protocol};if(initialData.type!=protocol.ignore){self.ondata(data)}};ws.onclose=function(e){};this.servers.push({socket:ws,protocol:protocol})};Exchange.prototype.ondata=function(data){if(data.to!=this.id){this.forward(data)}else if(data.type=="reliable"){this.handleReliable(data)}else{if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}if(this.managers[data.from]!==undefined){this.managers[data.from].ondata(data,data.path)}else{this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{},this.onpeerconnection);this.managers[data.from].ondata(data)}}};Exchange.prototype.forward=function(data){console.log("forwarding: ",data);if(this.connections[data.to]!==undefined){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}this._send(JSON.stringify(data),data.to)}else if(data.path.indexOf(this.id)+1==data.path.length||data.path.indexOf(this.id)==-1){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}for(var peer in this.connections){if(data.path.indexOf(peer)==-1){this._send(JSON.stringify(data),peer)}}}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer);this._send(JSON.stringify(data),nextPeer)}};Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hash")){if(data.hasOwnProperty("count")){this.messages[data.hash]=[];console.log(parseInt(data.count));for(var i=0;i<parseInt(data.count);i++){this.messages[data.hash][i]=false}console.log("setting up messages");console.log(this.messages)}if(data.hasOwnProperty("data")){console.log(parseInt(data.key));console.log(this.messages);this.messages[data.hash][parseInt(data.key)]=data.data}var ready=true;for(var i=0;i<this.messages[data.hash].length;i++){ready=ready&&this.messages[data.hash][i]}if(ready){var newdata="";for(var i=0;i<this.messages[data.hash].length;i++){newdata+=this.messages[data.hash][i]}this.messages[data.hash]=null;delete this.messages[data.hash];console.log(newdata);newdata=JSON.parse(newdata);newdata.path=data.path;newdata.from=data.from;newdata.to=data.to;this.ondata(newdata)}}};Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);var self=this;var parts=[];var hash=md5(string);console.log(hash);for(var i=0;i<string.length;i+=512){var str=string.substr(i,512);parts.push(str)}var partsPacket={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,count:parts.length};this._send(JSON.stringify(partsPacket),peer);for(var key in parts){var part={exchange:"true",type:"reliable",path:path,from:this.id,to:to,hash:hash,key:key,data:parts[key]};this._send(JSON.stringify(part),peer)}};Exchange.prototype.emit=function(data,to,path){if(path.indexOf(to)+1==path.length&&path.indexOf(this.id)==-1){path.unshift(this.id)}if(this.connections[to]!==undefined){if(path.indexOf(this.id)==-1){path.push(this.id)}this.reliable(JSON.stringify(data),to,path,to)}else if(path.indexOf(this.id)+1==path.length||path.indexOf(this.id)==-1){if(path.indexOf(this.id)==-1){path.push(this.id)}for(var peer in this.connections){if(path.indexOf(peer)==-1){this.reliable(JSON.stringify(data),peer,[],to)}}for(var i=0;i<this.servers.length;i++){var server=this.servers[i];if(server.socket.readyState==1){console.log(server);var serverData={};serverData[server.protocol.to]=to;serverData[server.protocol.from]=this.id;serverData[server.protocol.type]=data.type;serverData[server.protocol.payload]=data.payload;console.log("sending to ",server.socket);console.log(serverData);server.socket.send(JSON.stringify(serverData))}}}else if(path.indexOf(this.id)>-1){var nextPeer=path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),path[nextPeer],path,to)}};Exchange.prototype.connect=function(peer){console.log("connecting to ",peer);this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{},this.onpeerconnection);return this.managers[peer]};var Exchange=function(id,onpeerconnection){var self=this;this.id=id;this.onpeerconnection=onpeerconnection;this.managers={};if(arguments.length>1){this.connections=arguments[1];for(var peer in this.connections){this.initDC(this.connections[peer],peer,this.onpeerconnection)}}else{this.connections={}}this.messages={}};Exchange.prototype.initDC=function(dc,peer,callback){var self=this;var datacallback=dc.onmessage;dc.onmessage=function(e){var data=JSON.parse(e.data);if(data.exchange){self.ondata(data)}else{datacallback(e)}}};Exchange.prototype.ondata=function(data){if(data.to!=this.id){this.forward(data)}else if(data.type=="reliable"){this.handleReliable(data)}else{if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}if(this.managers[data.from]!==undefined){this.managers[data.from].ondata(data)}else{this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{config:{}},this.onpeerconnection);this.managers[data.from].ondata(data)}}};Exchange.prototype.forward=function(data){console.log("forwarding: ",data);if(this.connections[data.to]!==undefined){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}this.connections[data.to].send(JSON.stringify(data))}else if(data.path.indexOf(this.id)+1==data.path.length||data.path.indexOf(this.id)==-1){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}for(var peer in this.connections){if(data.path.indexOf(peer)==-1){this.connections[peer].send(JSON.stringify(data))}}}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer);this.connections[nextPeer].send(JSON.stringify(data))}};Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hashes")){var keysString=data.hashes.join("/");this.messages[keysString]={};for(var i=0;i<data.hashes.length;i++){this.messages[keysString][data.hashes[i]]=false}}else if(data.hasOwnProperty("hash")){for(var keys in this.messages){if(keys.indexOf(data.hash)>-1){this.messages[keys][data.hash]=data.data;var ready=true;for(var hash in this.messages[keys]){ready=ready&&this.messages[keys][hash]}if(ready){var newdata="";for(var hash in this.messages[keys]){newdata+=this.messages[keys][hash]}this.messages[keys]=null;delete this.messages[keys];newdata=JSON.parse(newdata);newdata.path=data.path;this.ondata(newdata)}}}}};Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);var parts={};for(var i=0;i<string.length;i+=512){var str=string.substr(i,512);parts[md5(str)]=str}this.connections[peer].send(JSON.stringify({exchange:true,type:"reliable",path:path,from:this.id,to:to,hashes:Object.keys(parts)}));for(var key in parts){this.connections[peer].send(JSON.stringify({exchange:true,type:"reliable",path:path,from:this.id,to:to,hash:key,data:parts[key]}))}};Exchange.prototype.emit=function(data){console.log(data);if(data.path.indexOf(data.to)+1==data.path.length&&data.path.indexOf(this.id)==-1){data.path.unshift(this.id)}if(this.connections[data.to]!==undefined){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}this.reliable(JSON.stringify(data),data.to,data.path,data.to)}else if(data.path.indexOf(this.id)+1==data.path.length||data.path.indexOf(this.id)==-1){if(data.path.indexOf(this.id)==-1){data.path.push(this.id)}for(var peer in this.connections){if(data.path.indexOf(peer)==-1){this.reliable(JSON.stringify(data),peer,data.path,data.to)}}}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),data.path[nextPeer],data.path,data.to)}};Exchange.prototype.connect=function(peer){console.log("connecting to ",peer);this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{config:{}},this.onpeerconnection);return this.managers[peer]};function ExchangeManager(id,peer,path,exchange,options,callback){void 0===options.config.iceServers&&(options.config.iceServers=[{url:"stun:stun.l.google.com:19302"}]),this._options=options,this.path=path,this._send=function(data){data.exchange=!0,data.path=this.path,data.from=id,data.to=peer,exchange.emit(data)},this.id=id,this.peer=peer,this.pc=null,this.labels={},this._default=0,this.onpeerconnection="function"==typeof callback?callback:function(){},this.id&&this.initialize()}function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936),d=ff(d,a,b,c,k[1],12,-389564586),c=ff(c,d,a,b,k[2],17,606105819),b=ff(b,c,d,a,k[3],22,-1044525330),a=ff(a,b,c,d,k[4],7,-176418897),d=ff(d,a,b,c,k[5],12,1200080426),c=ff(c,d,a,b,k[6],17,-1473231341),b=ff(b,c,d,a,k[7],22,-45705983),a=ff(a,b,c,d,k[8],7,1770035416),d=ff(d,a,b,c,k[9],12,-1958414417),c=ff(c,d,a,b,k[10],17,-42063),b=ff(b,c,d,a,k[11],22,-1990404162),a=ff(a,b,c,d,k[12],7,1804603682),d=ff(d,a,b,c,k[13],12,-40341101),c=ff(c,d,a,b,k[14],17,-1502002290),b=ff(b,c,d,a,k[15],22,1236535329),a=gg(a,b,c,d,k[1],5,-165796510),d=gg(d,a,b,c,k[6],9,-1069501632),c=gg(c,d,a,b,k[11],14,643717713),b=gg(b,c,d,a,k[0],20,-373897302),a=gg(a,b,c,d,k[5],5,-701558691),d=gg(d,a,b,c,k[10],9,38016083),c=gg(c,d,a,b,k[15],14,-660478335),b=gg(b,c,d,a,k[4],20,-405537848),a=gg(a,b,c,d,k[9],5,568446438),d=gg(d,a,b,c,k[14],9,-1019803690),c=gg(c,d,a,b,k[3],14,-187363961),b=gg(b,c,d,a,k[8],20,1163531501),a=gg(a,b,c,d,k[13],5,-1444681467),d=gg(d,a,b,c,k[2],9,-51403784),c=gg(c,d,a,b,k[7],14,1735328473),b=gg(b,c,d,a,k[12],20,-1926607734),a=hh(a,b,c,d,k[5],4,-378558),d=hh(d,a,b,c,k[8],11,-2022574463),c=hh(c,d,a,b,k[11],16,1839030562),b=hh(b,c,d,a,k[14],23,-35309556),a=hh(a,b,c,d,k[1],4,-1530992060),d=hh(d,a,b,c,k[4],11,1272893353),c=hh(c,d,a,b,k[7],16,-155497632),b=hh(b,c,d,a,k[10],23,-1094730640),a=hh(a,b,c,d,k[13],4,681279174),d=hh(d,a,b,c,k[0],11,-358537222),c=hh(c,d,a,b,k[3],16,-722521979),b=hh(b,c,d,a,k[6],23,76029189),a=hh(a,b,c,d,k[9],4,-640364487),d=hh(d,a,b,c,k[12],11,-421815835),c=hh(c,d,a,b,k[15],16,530742520),b=hh(b,c,d,a,k[2],23,-995338651),a=ii(a,b,c,d,k[0],6,-198630844),d=ii(d,a,b,c,k[7],10,1126891415),c=ii(c,d,a,b,k[14],15,-1416354905),b=ii(b,c,d,a,k[5],21,-57434055),a=ii(a,b,c,d,k[12],6,1700485571),d=ii(d,a,b,c,k[3],10,-1894986606),c=ii(c,d,a,b,k[10],15,-1051523),b=ii(b,c,d,a,k[1],21,-2054922799),a=ii(a,b,c,d,k[8],6,1873313359),d=ii(d,a,b,c,k[15],10,-30611744),c=ii(c,d,a,b,k[6],15,-1560198380),b=ii(b,c,d,a,k[13],21,1309151649),a=ii(a,b,c,d,k[4],6,-145523070),d=ii(d,a,b,c,k[11],10,-1120210379),c=ii(c,d,a,b,k[2],15,718787259),b=ii(b,c,d,a,k[9],21,-343485551),x[0]=add32(a,x[0]),x[1]=add32(b,x[1]),x[2]=add32(c,x[2]),x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){return a=add32(add32(a,q),add32(x,t)),add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var i,n=s.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;16>i;i++)tail[i]=0;return tail[14]=8*n,md5cycle(state,tail),state}function md5blk(s){var i,md5blks=[];for(i=0;64>i;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}function rhex(n){for(var s="",j=0;4>j;j++)s+=hex_chr[15&n>>8*j+4]+hex_chr[15&n>>8*j];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return 4294967295&a+b}function add32(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}function ExchangeManager(id,peer,path,exchange,options,callback){void 0===options.config.iceServers&&(options.config.iceServers=[{url:"stun:stun.l.google.com:19302"}]),this._options=options,this.path=path,this._send=function(data){data.exchange=!0,data.path=this.path,data.from=id,data.to=peer,exchange.emit(data)},this.id=id,this.peer=peer,this.pc=null,this.labels={},this._default=0,this.onpeerconnection="function"==typeof callback?callback:function(){},this.id&&this.initialize()}function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936),d=ff(d,a,b,c,k[1],12,-389564586),c=ff(c,d,a,b,k[2],17,606105819),b=ff(b,c,d,a,k[3],22,-1044525330),a=ff(a,b,c,d,k[4],7,-176418897),d=ff(d,a,b,c,k[5],12,1200080426),c=ff(c,d,a,b,k[6],17,-1473231341),b=ff(b,c,d,a,k[7],22,-45705983),a=ff(a,b,c,d,k[8],7,1770035416),d=ff(d,a,b,c,k[9],12,-1958414417),c=ff(c,d,a,b,k[10],17,-42063),b=ff(b,c,d,a,k[11],22,-1990404162),a=ff(a,b,c,d,k[12],7,1804603682),d=ff(d,a,b,c,k[13],12,-40341101),c=ff(c,d,a,b,k[14],17,-1502002290),b=ff(b,c,d,a,k[15],22,1236535329),a=gg(a,b,c,d,k[1],5,-165796510),d=gg(d,a,b,c,k[6],9,-1069501632),c=gg(c,d,a,b,k[11],14,643717713),b=gg(b,c,d,a,k[0],20,-373897302),a=gg(a,b,c,d,k[5],5,-701558691),d=gg(d,a,b,c,k[10],9,38016083),c=gg(c,d,a,b,k[15],14,-660478335),b=gg(b,c,d,a,k[4],20,-405537848),a=gg(a,b,c,d,k[9],5,568446438),d=gg(d,a,b,c,k[14],9,-1019803690),c=gg(c,d,a,b,k[3],14,-187363961),b=gg(b,c,d,a,k[8],20,1163531501),a=gg(a,b,c,d,k[13],5,-1444681467),d=gg(d,a,b,c,k[2],9,-51403784),c=gg(c,d,a,b,k[7],14,1735328473),b=gg(b,c,d,a,k[12],20,-1926607734),a=hh(a,b,c,d,k[5],4,-378558),d=hh(d,a,b,c,k[8],11,-2022574463),c=hh(c,d,a,b,k[11],16,1839030562),b=hh(b,c,d,a,k[14],23,-35309556),a=hh(a,b,c,d,k[1],4,-1530992060),d=hh(d,a,b,c,k[4],11,1272893353),c=hh(c,d,a,b,k[7],16,-155497632),b=hh(b,c,d,a,k[10],23,-1094730640),a=hh(a,b,c,d,k[13],4,681279174),d=hh(d,a,b,c,k[0],11,-358537222),c=hh(c,d,a,b,k[3],16,-722521979),b=hh(b,c,d,a,k[6],23,76029189),a=hh(a,b,c,d,k[9],4,-640364487),d=hh(d,a,b,c,k[12],11,-421815835),c=hh(c,d,a,b,k[15],16,530742520),b=hh(b,c,d,a,k[2],23,-995338651),a=ii(a,b,c,d,k[0],6,-198630844),d=ii(d,a,b,c,k[7],10,1126891415),c=ii(c,d,a,b,k[14],15,-1416354905),b=ii(b,c,d,a,k[5],21,-57434055),a=ii(a,b,c,d,k[12],6,1700485571),d=ii(d,a,b,c,k[3],10,-1894986606),c=ii(c,d,a,b,k[10],15,-1051523),b=ii(b,c,d,a,k[1],21,-2054922799),a=ii(a,b,c,d,k[8],6,1873313359),d=ii(d,a,b,c,k[15],10,-30611744),c=ii(c,d,a,b,k[6],15,-1560198380),b=ii(b,c,d,a,k[13],21,1309151649),a=ii(a,b,c,d,k[4],6,-145523070),d=ii(d,a,b,c,k[11],10,-1120210379),c=ii(c,d,a,b,k[2],15,718787259),b=ii(b,c,d,a,k[9],21,-343485551),x[0]=add32(a,x[0]),x[1]=add32(b,x[1]),x[2]=add32(c,x[2]),x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){return a=add32(add32(a,q),add32(x,t)),add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var i,n=s.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;16>i;i++)tail[i]=0;return tail[14]=8*n,md5cycle(state,tail),state}function md5blk(s){var i,md5blks=[];for(i=0;64>i;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}function rhex(n){for(var s="",j=0;4>j;j++)s+=hex_chr[15&n>>8*j+4]+hex_chr[15&n>>8*j];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return 4294967295&a+b}function add32(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}var Exchange=function(id,onpeerconnection){if(this.id=id,this.onpeerconnection=onpeerconnection,this.managers={},arguments.length>1){this.connections=arguments[1];
for(var peer in this.connections)this.initDC(this.connections[peer],peer,this.onpeerconnection)}else this.connections={};this.messages={}};Exchange.prototype.initDC=function(dc){var self=this,datacallback=dc.onmessage;dc.onmessage=function(e){var data=JSON.parse(e.data);data.exchange?self.ondata(data):datacallback(e)}},Exchange.prototype.ondata=function(data){data.to!=this.id?this.forward(data):"reliable"==data.type?this.handleReliable(data):(-1==data.path.indexOf(this.id)&&data.path.push(this.id),void 0!==this.managers[data.from]?this.managers[data.from].ondata(data):(this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{config:{}},this.onpeerconnection),this.managers[data.from].ondata(data)))},Exchange.prototype.forward=function(data){if(console.log("forwarding: ",data),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.connections[data.to].send(JSON.stringify(data));else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.connections[peer].send(JSON.stringify(data))}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer),this.connections[nextPeer].send(JSON.stringify(data))}},Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hashes")){var keysString=data.hashes.join("/");this.messages[keysString]={};for(var i=0;i<data.hashes.length;i++)this.messages[keysString][data.hashes[i]]=!1}else if(data.hasOwnProperty("hash"))for(var keys in this.messages)if(keys.indexOf(data.hash)>-1){this.messages[keys][data.hash]=data.data;var ready=!0;for(var hash in this.messages[keys])ready=ready&&this.messages[keys][hash];if(ready){var newdata="";for(var hash in this.messages[keys])newdata+=this.messages[keys][hash];this.messages[keys]=null,delete this.messages[keys],newdata=JSON.parse(newdata),newdata.path=data.path,this.ondata(newdata)}}},Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);for(var parts={},i=0;i<string.length;i+=512){var str=string.substr(i,512);parts[md5(str)]=str}this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hashes:Object.keys(parts)}));for(var key in parts)this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hash:key,data:parts[key]}))},Exchange.prototype.emit=function(data){if(console.log(data),data.path.indexOf(data.to)+1==data.path.length&&-1==data.path.indexOf(this.id)&&data.path.unshift(this.id),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.reliable(JSON.stringify(data),data.to,data.path,data.to);else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.reliable(JSON.stringify(data),peer,data.path,data.to)}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),data.path[nextPeer],data.path,data.to)}},Exchange.prototype.connect=function(peer){return console.log("connecting to ",peer),this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{config:{}},this.onpeerconnection),this.managers[peer]};var Exchange=function(id,onpeerconnection){if(this.id=id,this.onpeerconnection=onpeerconnection,this.managers={},arguments.length>1){this.connections=arguments[1];for(var peer in this.connections)this.initDC(this.connections[peer],peer,this.onpeerconnection)}else this.connections={};this.messages={}};Exchange.prototype.initDC=function(dc){var self=this,datacallback=dc.onmessage;dc.onmessage=function(e){var data=JSON.parse(e.data);data.exchange?self.ondata(data):datacallback(e)}},Exchange.prototype.ondata=function(data){data.to!=this.id?this.forward(data):"reliable"==data.type?this.handleReliable(data):(-1==data.path.indexOf(this.id)&&data.path.push(this.id),void 0!==this.managers[data.from]?this.managers[data.from].ondata(data):(this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{config:{}},this.onpeerconnection),this.managers[data.from].ondata(data)))},Exchange.prototype.forward=function(data){if(console.log("forwarding: ",data),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.connections[data.to].send(JSON.stringify(data));else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.connections[peer].send(JSON.stringify(data))}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer),this.connections[nextPeer].send(JSON.stringify(data))}},Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hashes")){var keysString=data.hashes.join("/");this.messages[keysString]={};for(var i=0;i<data.hashes.length;i++)this.messages[keysString][data.hashes[i]]=!1}else if(data.hasOwnProperty("hash"))for(var keys in this.messages)if(keys.indexOf(data.hash)>-1){this.messages[keys][data.hash]=data.data;var ready=!0;for(var hash in this.messages[keys])ready=ready&&this.messages[keys][hash];if(ready){var newdata="";for(var hash in this.messages[keys])newdata+=this.messages[keys][hash];this.messages[keys]=null,delete this.messages[keys],newdata=JSON.parse(newdata),newdata.path=data.path,this.ondata(newdata)}}},Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);for(var parts={},i=0;i<string.length;i+=512){var str=string.substr(i,512);parts[md5(str)]=str}this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hashes:Object.keys(parts)}));for(var key in parts)this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hash:key,data:parts[key]}))},Exchange.prototype.emit=function(data){if(console.log(data),data.path.indexOf(data.to)+1==data.path.length&&-1==data.path.indexOf(this.id)&&data.path.unshift(this.id),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.reliable(JSON.stringify(data),data.to,data.path,data.to);else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.reliable(JSON.stringify(data),peer,data.path,data.to)}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),data.path[nextPeer],data.path,data.to)}},Exchange.prototype.connect=function(peer){return console.log("connecting to ",peer),this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{config:{}},this.onpeerconnection),this.managers[peer]},!function(exports,global){function ExchangeManager(id,peer,path,exchange,options,callback){void 0===options.config.iceServers&&(options.config.iceServers=[{url:"stun:stun.l.google.com:19302"}]),this._options=options,this.path=path,this._send=function(data){data.exchange=!0,data.path=this.path,data.from=id,data.to=peer,exchange.emit(data)},this.id=id,this.peer=peer,this.pc=null,this.labels={},this._default=0,this.onpeerconnection="function"==typeof callback?callback:function(){},this.id&&this.initialize()}function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936),d=ff(d,a,b,c,k[1],12,-389564586),c=ff(c,d,a,b,k[2],17,606105819),b=ff(b,c,d,a,k[3],22,-1044525330),a=ff(a,b,c,d,k[4],7,-176418897),d=ff(d,a,b,c,k[5],12,1200080426),c=ff(c,d,a,b,k[6],17,-1473231341),b=ff(b,c,d,a,k[7],22,-45705983),a=ff(a,b,c,d,k[8],7,1770035416),d=ff(d,a,b,c,k[9],12,-1958414417),c=ff(c,d,a,b,k[10],17,-42063),b=ff(b,c,d,a,k[11],22,-1990404162),a=ff(a,b,c,d,k[12],7,1804603682),d=ff(d,a,b,c,k[13],12,-40341101),c=ff(c,d,a,b,k[14],17,-1502002290),b=ff(b,c,d,a,k[15],22,1236535329),a=gg(a,b,c,d,k[1],5,-165796510),d=gg(d,a,b,c,k[6],9,-1069501632),c=gg(c,d,a,b,k[11],14,643717713),b=gg(b,c,d,a,k[0],20,-373897302),a=gg(a,b,c,d,k[5],5,-701558691),d=gg(d,a,b,c,k[10],9,38016083),c=gg(c,d,a,b,k[15],14,-660478335),b=gg(b,c,d,a,k[4],20,-405537848),a=gg(a,b,c,d,k[9],5,568446438),d=gg(d,a,b,c,k[14],9,-1019803690),c=gg(c,d,a,b,k[3],14,-187363961),b=gg(b,c,d,a,k[8],20,1163531501),a=gg(a,b,c,d,k[13],5,-1444681467),d=gg(d,a,b,c,k[2],9,-51403784),c=gg(c,d,a,b,k[7],14,1735328473),b=gg(b,c,d,a,k[12],20,-1926607734),a=hh(a,b,c,d,k[5],4,-378558),d=hh(d,a,b,c,k[8],11,-2022574463),c=hh(c,d,a,b,k[11],16,1839030562),b=hh(b,c,d,a,k[14],23,-35309556),a=hh(a,b,c,d,k[1],4,-1530992060),d=hh(d,a,b,c,k[4],11,1272893353),c=hh(c,d,a,b,k[7],16,-155497632),b=hh(b,c,d,a,k[10],23,-1094730640),a=hh(a,b,c,d,k[13],4,681279174),d=hh(d,a,b,c,k[0],11,-358537222),c=hh(c,d,a,b,k[3],16,-722521979),b=hh(b,c,d,a,k[6],23,76029189),a=hh(a,b,c,d,k[9],4,-640364487),d=hh(d,a,b,c,k[12],11,-421815835),c=hh(c,d,a,b,k[15],16,530742520),b=hh(b,c,d,a,k[2],23,-995338651),a=ii(a,b,c,d,k[0],6,-198630844),d=ii(d,a,b,c,k[7],10,1126891415),c=ii(c,d,a,b,k[14],15,-1416354905),b=ii(b,c,d,a,k[5],21,-57434055),a=ii(a,b,c,d,k[12],6,1700485571),d=ii(d,a,b,c,k[3],10,-1894986606),c=ii(c,d,a,b,k[10],15,-1051523),b=ii(b,c,d,a,k[1],21,-2054922799),a=ii(a,b,c,d,k[8],6,1873313359),d=ii(d,a,b,c,k[15],10,-30611744),c=ii(c,d,a,b,k[6],15,-1560198380),b=ii(b,c,d,a,k[13],21,1309151649),a=ii(a,b,c,d,k[4],6,-145523070),d=ii(d,a,b,c,k[11],10,-1120210379),c=ii(c,d,a,b,k[2],15,718787259),b=ii(b,c,d,a,k[9],21,-343485551),x[0]=add32(a,x[0]),x[1]=add32(b,x[1]),x[2]=add32(c,x[2]),x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){return a=add32(add32(a,q),add32(x,t)),add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var i,n=s.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;16>i;i++)tail[i]=0;return tail[14]=8*n,md5cycle(state,tail),state}function md5blk(s){var i,md5blks=[];for(i=0;64>i;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}function rhex(n){for(var s="",j=0;4>j;j++)s+=hex_chr[15&n>>8*j+4]+hex_chr[15&n>>8*j];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return 4294967295&a+b}function add32(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}global.true=exports;var Exchange=function(id,onpeerconnection){if(this.id=id,this.onpeerconnection=onpeerconnection,this.managers={},arguments.length>1){this.connections=arguments[1];for(var peer in this.connections)this.initDC(this.connections[peer],peer,this.onpeerconnection)}else this.connections={};this.messages={}};Exchange.prototype.initDC=function(dc){var self=this,datacallback=dc.onmessage;dc.onmessage=function(e){var data=JSON.parse(e.data);data.exchange?self.ondata(data):datacallback(e)}},Exchange.prototype.ondata=function(data){data.to!=this.id?this.forward(data):"reliable"==data.type?this.handleReliable(data):(-1==data.path.indexOf(this.id)&&data.path.push(this.id),void 0!==this.managers[data.from]?this.managers[data.from].ondata(data):(this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{config:{}},this.onpeerconnection),this.managers[data.from].ondata(data)))},Exchange.prototype.forward=function(data){if(console.log("forwarding: ",data),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.connections[data.to].send(JSON.stringify(data));else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.connections[peer].send(JSON.stringify(data))}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer),this.connections[nextPeer].send(JSON.stringify(data))}},Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hashes")){var keysString=data.hashes.join("/");this.messages[keysString]={};for(var i=0;i<data.hashes.length;i++)this.messages[keysString][data.hashes[i]]=!1}else if(data.hasOwnProperty("hash"))for(var keys in this.messages)if(keys.indexOf(data.hash)>-1){this.messages[keys][data.hash]=data.data;var ready=!0;for(var hash in this.messages[keys])ready=ready&&this.messages[keys][hash];if(ready){var newdata="";for(var hash in this.messages[keys])newdata+=this.messages[keys][hash];this.messages[keys]=null,delete this.messages[keys],newdata=JSON.parse(newdata),newdata.path=data.path,this.ondata(newdata)}}},Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);for(var parts={},i=0;i<string.length;i+=512){var str=string.substr(i,512);parts[md5(str)]=str}this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hashes:Object.keys(parts)}));for(var key in parts)this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hash:key,data:parts[key]}))},Exchange.prototype.emit=function(data){if(console.log(data),data.path.indexOf(data.to)+1==data.path.length&&-1==data.path.indexOf(this.id)&&data.path.unshift(this.id),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.reliable(JSON.stringify(data),data.to,data.path,data.to);else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.reliable(JSON.stringify(data),peer,data.path,data.to)}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),data.path[nextPeer],data.path,data.to)}},Exchange.prototype.connect=function(peer){return console.log("connecting to ",peer),this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{config:{}},this.onpeerconnection),this.managers[peer]},ExchangeManager.prototype.ondata=function(data){switch(this.path=data.path.reverse(),console.log(this.path),data.type){case"OFFER":this.update(data.payload.labels),this.handleSDP(data.payload.sdp,data.type);break;case"ANSWER":this.handleSDP(data.payload.sdp,data.type);break;case"CANDIDATE":this.handleCandidate(data.payload,data.type);break;case"PORT":this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data)}},ExchangeManager.prototype.initialize=function(id){id&&(this.id=id),this._startPeerConnection(),this._setupIce(),this._setupNegotiationHandler(),this.initialize=function(){}},ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC"),this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:!0}]}),this.onpeerconnection(this.pc)},ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE"),this.pc.onicecandidate=function(evt){evt.candidate&&self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}},ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer."),self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer."),self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){throw err})},function(err){throw err})},ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`"),this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered"),self._makeOffer()}},ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer"),console.log("Created offer."),self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}}),self.labels={}},function(err){throw err})})},ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection."),ExchangeManager.usedPorts||(ExchangeManager.usedPorts=[]),ExchangeManager.usedPorts.push(ports.local),ExchangeManager.usedPorts.push(ports.remote),this.pc.connectDataConnection(ports.local,ports.remote)},ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type),sdp=new RTCSessionDescription(sdp),console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type),"OFFER"===type&&self._makeAnswer()},function(err){throw err})},ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate),console.log("Added ICE candidate.")},ExchangeManager.prototype.update=function(updates){for(var labels=Object.keys(updates),i=0,ii=labels.length;ii>i;i+=1){var label=labels[i];this.labels[label]=updates[label]}},!function(exports,global){function ExchangeManager(id,peer,path,exchange,options,callback){void 0===options.config.iceServers&&(options.config.iceServers=[{url:"stun:stun.l.google.com:19302"}]),this._options=options,this.path=path,this._send=function(data){data.exchange=!0,data.path=this.path,data.from=id,data.to=peer,exchange.emit(data)},this.id=id,this.peer=peer,this.pc=null,this.labels={},this._default=0,this.onpeerconnection="function"==typeof callback?callback:function(){},this.id&&this.initialize()}function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936),d=ff(d,a,b,c,k[1],12,-389564586),c=ff(c,d,a,b,k[2],17,606105819),b=ff(b,c,d,a,k[3],22,-1044525330),a=ff(a,b,c,d,k[4],7,-176418897),d=ff(d,a,b,c,k[5],12,1200080426),c=ff(c,d,a,b,k[6],17,-1473231341),b=ff(b,c,d,a,k[7],22,-45705983),a=ff(a,b,c,d,k[8],7,1770035416),d=ff(d,a,b,c,k[9],12,-1958414417),c=ff(c,d,a,b,k[10],17,-42063),b=ff(b,c,d,a,k[11],22,-1990404162),a=ff(a,b,c,d,k[12],7,1804603682),d=ff(d,a,b,c,k[13],12,-40341101),c=ff(c,d,a,b,k[14],17,-1502002290),b=ff(b,c,d,a,k[15],22,1236535329),a=gg(a,b,c,d,k[1],5,-165796510),d=gg(d,a,b,c,k[6],9,-1069501632),c=gg(c,d,a,b,k[11],14,643717713),b=gg(b,c,d,a,k[0],20,-373897302),a=gg(a,b,c,d,k[5],5,-701558691),d=gg(d,a,b,c,k[10],9,38016083),c=gg(c,d,a,b,k[15],14,-660478335),b=gg(b,c,d,a,k[4],20,-405537848),a=gg(a,b,c,d,k[9],5,568446438),d=gg(d,a,b,c,k[14],9,-1019803690),c=gg(c,d,a,b,k[3],14,-187363961),b=gg(b,c,d,a,k[8],20,1163531501),a=gg(a,b,c,d,k[13],5,-1444681467),d=gg(d,a,b,c,k[2],9,-51403784),c=gg(c,d,a,b,k[7],14,1735328473),b=gg(b,c,d,a,k[12],20,-1926607734),a=hh(a,b,c,d,k[5],4,-378558),d=hh(d,a,b,c,k[8],11,-2022574463),c=hh(c,d,a,b,k[11],16,1839030562),b=hh(b,c,d,a,k[14],23,-35309556),a=hh(a,b,c,d,k[1],4,-1530992060),d=hh(d,a,b,c,k[4],11,1272893353),c=hh(c,d,a,b,k[7],16,-155497632),b=hh(b,c,d,a,k[10],23,-1094730640),a=hh(a,b,c,d,k[13],4,681279174),d=hh(d,a,b,c,k[0],11,-358537222),c=hh(c,d,a,b,k[3],16,-722521979),b=hh(b,c,d,a,k[6],23,76029189),a=hh(a,b,c,d,k[9],4,-640364487),d=hh(d,a,b,c,k[12],11,-421815835),c=hh(c,d,a,b,k[15],16,530742520),b=hh(b,c,d,a,k[2],23,-995338651),a=ii(a,b,c,d,k[0],6,-198630844),d=ii(d,a,b,c,k[7],10,1126891415),c=ii(c,d,a,b,k[14],15,-1416354905),b=ii(b,c,d,a,k[5],21,-57434055),a=ii(a,b,c,d,k[12],6,1700485571),d=ii(d,a,b,c,k[3],10,-1894986606),c=ii(c,d,a,b,k[10],15,-1051523),b=ii(b,c,d,a,k[1],21,-2054922799),a=ii(a,b,c,d,k[8],6,1873313359),d=ii(d,a,b,c,k[15],10,-30611744),c=ii(c,d,a,b,k[6],15,-1560198380),b=ii(b,c,d,a,k[13],21,1309151649),a=ii(a,b,c,d,k[4],6,-145523070),d=ii(d,a,b,c,k[11],10,-1120210379),c=ii(c,d,a,b,k[2],15,718787259),b=ii(b,c,d,a,k[9],21,-343485551),x[0]=add32(a,x[0]),x[1]=add32(b,x[1]),x[2]=add32(c,x[2]),x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){return a=add32(add32(a,q),add32(x,t)),add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var i,n=s.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;16>i;i++)tail[i]=0;return tail[14]=8*n,md5cycle(state,tail),state}function md5blk(s){var i,md5blks=[];for(i=0;64>i;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}function rhex(n){for(var s="",j=0;4>j;j++)s+=hex_chr[15&n>>8*j+4]+hex_chr[15&n>>8*j];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return 4294967295&a+b}function add32(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}global.true=exports;var Exchange=function(id,onpeerconnection){if(this.id=id,this.onpeerconnection=onpeerconnection,this.managers={},arguments.length>1){this.connections=arguments[1];for(var peer in this.connections)this.initDC(this.connections[peer],peer,this.onpeerconnection)}else this.connections={};this.messages={}};Exchange.prototype.initDC=function(dc){var self=this,datacallback=dc.onmessage;dc.onmessage=function(e){var data=JSON.parse(e.data);data.exchange?self.ondata(data):datacallback(e)}},Exchange.prototype.ondata=function(data){data.to!=this.id?this.forward(data):"reliable"==data.type?this.handleReliable(data):(-1==data.path.indexOf(this.id)&&data.path.push(this.id),void 0!==this.managers[data.from]?this.managers[data.from].ondata(data):(this.managers[data.from]=new ExchangeManager(this.id,data.from,data.path.reverse(),this,{config:{}},this.onpeerconnection),this.managers[data.from].ondata(data)))},Exchange.prototype.forward=function(data){if(console.log("forwarding: ",data),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.connections[data.to].send(JSON.stringify(data));else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.connections[peer].send(JSON.stringify(data))}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path[data.path.indexOf(this.id)+1];console.log(nextPeer),this.connections[nextPeer].send(JSON.stringify(data))}},Exchange.prototype.handleReliable=function(data){if(data.hasOwnProperty("hashes")){var keysString=data.hashes.join("/");this.messages[keysString]={};for(var i=0;i<data.hashes.length;i++)this.messages[keysString][data.hashes[i]]=!1}else if(data.hasOwnProperty("hash"))for(var keys in this.messages)if(keys.indexOf(data.hash)>-1){this.messages[keys][data.hash]=data.data;var ready=!0;for(var hash in this.messages[keys])ready=ready&&this.messages[keys][hash];if(ready){var newdata="";for(var hash in this.messages[keys])newdata+=this.messages[keys][hash];this.messages[keys]=null,delete this.messages[keys],newdata=JSON.parse(newdata),newdata.path=data.path,this.ondata(newdata)}}},Exchange.prototype.reliable=function(string,peer,path,to){console.log(peer);for(var parts={},i=0;i<string.length;i+=512){var str=string.substr(i,512);parts[md5(str)]=str}this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hashes:Object.keys(parts)}));for(var key in parts)this.connections[peer].send(JSON.stringify({exchange:!0,type:"reliable",path:path,from:this.id,to:to,hash:key,data:parts[key]}))},Exchange.prototype.emit=function(data){if(console.log(data),data.path.indexOf(data.to)+1==data.path.length&&-1==data.path.indexOf(this.id)&&data.path.unshift(this.id),void 0!==this.connections[data.to])-1==data.path.indexOf(this.id)&&data.path.push(this.id),this.reliable(JSON.stringify(data),data.to,data.path,data.to);else if(data.path.indexOf(this.id)+1==data.path.length||-1==data.path.indexOf(this.id)){-1==data.path.indexOf(this.id)&&data.path.push(this.id);for(var peer in this.connections)-1==data.path.indexOf(peer)&&this.reliable(JSON.stringify(data),peer,data.path,data.to)}else if(data.path.indexOf(this.id)>-1){var nextPeer=data.path.indexOf(this.id)+1;this.reliable(JSON.stringify(data),data.path[nextPeer],data.path,data.to)}},Exchange.prototype.connect=function(peer){return console.log("connecting to ",peer),this.managers[peer]=new ExchangeManager(this.id,peer,[],this,{config:{}},this.onpeerconnection),this.managers[peer]},ExchangeManager.prototype.ondata=function(data){switch(this.path=data.path.reverse(),console.log(this.path),data.type){case"OFFER":this.update(data.payload.labels),this.handleSDP(data.payload.sdp,data.type);break;case"ANSWER":this.handleSDP(data.payload.sdp,data.type);break;case"CANDIDATE":this.handleCandidate(data.payload,data.type);break;case"PORT":this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data)}},ExchangeManager.prototype.initialize=function(id){id&&(this.id=id),this._startPeerConnection(),this._setupIce(),this._setupNegotiationHandler(),this.initialize=function(){}},ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC"),this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:!0}]}),this.onpeerconnection(this.pc)},ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE"),this.pc.onicecandidate=function(evt){evt.candidate&&self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}},ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer."),self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer."),self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){throw err})},function(err){throw err})},ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`"),this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered"),self._makeOffer()}},ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer"),console.log("Created offer."),self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}}),self.labels={}},function(err){throw err})})},ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection."),ExchangeManager.usedPorts||(ExchangeManager.usedPorts=[]),ExchangeManager.usedPorts.push(ports.local),ExchangeManager.usedPorts.push(ports.remote),this.pc.connectDataConnection(ports.local,ports.remote)},ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type),sdp=new RTCSessionDescription(sdp),console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type),"OFFER"===type&&self._makeAnswer()},function(err){throw err})},ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate),console.log("Added ICE candidate.")},ExchangeManager.prototype.update=function(updates){for(var labels=Object.keys(updates),i=0,ii=labels.length;ii>i;i+=1){var label=labels[i];this.labels[label]=updates[label]}};var hex_chr="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=md5("hello"),exports.Exchange=Exchange,exports.ExchangeManager=ExchangeManager,exports.md5cycle=md5cycle,exports.cmn=cmn,exports.ff=ff,exports.gg=gg,exports.hh=hh,exports.ii=ii,exports.md51=md51,exports.md5blk=md5blk,exports.hex_chr=hex_chr,exports.rhex=rhex,exports.hex=hex,exports.md5=md5,exports.add32=add32}({},function(){return this}());var hex_chr="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=md5("hello"),exports.Exchange=Exchange,exports.ExchangeManager=ExchangeManager,exports.md5cycle=md5cycle,exports.cmn=cmn,exports.ff=ff,exports.gg=gg,exports.hh=hh,exports.ii=ii,exports.md51=md51,exports.md5blk=md5blk,exports.hex_chr=hex_chr,exports.rhex=rhex,exports.hex=hex,exports.md5=md5,exports.add32=add32}({},function(){return this}()),ExchangeManager.prototype.ondata=function(data){switch(this.path=data.path.reverse(),console.log(this.path),data.type){case"OFFER":this.update(data.payload.labels),this.handleSDP(data.payload.sdp,data.type);break;case"ANSWER":this.handleSDP(data.payload.sdp,data.type);break;case"CANDIDATE":this.handleCandidate(data.payload,data.type);break;case"PORT":this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data)}},ExchangeManager.prototype.initialize=function(id){id&&(this.id=id),this._startPeerConnection(),this._setupIce(),this._setupNegotiationHandler(),this.initialize=function(){}},ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC"),this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:!0}]}),this.onpeerconnection(this.pc)},ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE"),this.pc.onicecandidate=function(evt){evt.candidate&&self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}},ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer."),self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer."),self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){throw err})},function(err){throw err})},ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`"),this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered"),self._makeOffer()}},ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer"),console.log("Created offer."),self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}}),self.labels={}},function(err){throw err})})},ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection."),ExchangeManager.usedPorts||(ExchangeManager.usedPorts=[]),ExchangeManager.usedPorts.push(ports.local),ExchangeManager.usedPorts.push(ports.remote),this.pc.connectDataConnection(ports.local,ports.remote)},ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type),sdp=new RTCSessionDescription(sdp),console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type),"OFFER"===type&&self._makeAnswer()},function(err){throw err})},ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate),console.log("Added ICE candidate.")},ExchangeManager.prototype.update=function(updates){for(var labels=Object.keys(updates),i=0,ii=labels.length;ii>i;i+=1){var label=labels[i];
this.labels[label]=updates[label]}};var hex_chr="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=md5("hello"),ExchangeManager.prototype.ondata=function(data){switch(this.path=data.path.reverse(),console.log(this.path),data.type){case"OFFER":this.update(data.payload.labels),this.handleSDP(data.payload.sdp,data.type);break;case"ANSWER":this.handleSDP(data.payload.sdp,data.type);break;case"CANDIDATE":this.handleCandidate(data.payload,data.type);break;case"PORT":this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data)}},ExchangeManager.prototype.initialize=function(id){id&&(this.id=id),this._startPeerConnection(),this._setupIce(),this._setupNegotiationHandler(),this.initialize=function(){}},ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC"),this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:!0}]}),this.onpeerconnection(this.pc)},ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE"),this.pc.onicecandidate=function(evt){evt.candidate&&self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}},ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer."),self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer."),self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){throw err})},function(err){throw err})},ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`"),this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered"),self._makeOffer()}},ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer"),console.log("Created offer."),self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}}),self.labels={}},function(err){throw err})})},ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection."),ExchangeManager.usedPorts||(ExchangeManager.usedPorts=[]),ExchangeManager.usedPorts.push(ports.local),ExchangeManager.usedPorts.push(ports.remote),this.pc.connectDataConnection(ports.local,ports.remote)},ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type),sdp=new RTCSessionDescription(sdp),console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type),"OFFER"===type&&self._makeAnswer()},function(err){throw err})},ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate),console.log("Added ICE candidate.")},ExchangeManager.prototype.update=function(updates){for(var labels=Object.keys(updates),i=0,ii=labels.length;ii>i;i+=1){var label=labels[i];this.labels[label]=updates[label]}};var hex_chr="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=md5("hello");function ExchangeManager(id,peer,path,exchange,options,callback){if(options.config.iceServers===undefined){options.config.iceServers=[{url:"stun:stun.l.google.com:19302"}]}this._options=options;this.path=path;this._send=function(data){data.exchange=true;data.path=this.path;data.from=id;data.to=peer;exchange.emit(data)};this.id=id;this.peer=peer;this.pc=null;this.labels={};this._default=0;if(typeof callback=="function"){this.onpeerconnection=callback}else{this.onpeerconnection=function(pc){}}if(!!this.id){this.initialize()}}ExchangeManager.prototype.ondata=function(data){this.path=data.path.reverse();console.log(this.path);switch(data.type){case"OFFER":this.update(data.payload.labels);this.handleSDP(data.payload.sdp,data.type);break;case"ANSWER":this.handleSDP(data.payload.sdp,data.type);break;case"CANDIDATE":this.handleCandidate(data.payload,data.type);break;case"PORT":this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data);break}};ExchangeManager.prototype.initialize=function(id){if(!!id){this.id=id}this._startPeerConnection();this._setupIce();this._setupNegotiationHandler();this.initialize=function(){}};ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC");this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:true}]});this.onpeerconnection(this.pc)};ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE");this.pc.onicecandidate=function(evt){if(evt.candidate){self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}}};ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer.");self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer.");self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){throw err;console.log("Failed to setLocalDescription from PEX, ",err)})},function(err){throw err;console.log("Failed to create answer, ",err)})};ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`");this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered");self._makeOffer()}};ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function setLocal(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer");console.log("Created offer.");self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}});self.labels={}},function handleError(err){throw err;console.log("Failed to setLocalDescription, ",err)})})};ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection.");if(!ExchangeManager.usedPorts){ExchangeManager.usedPorts=[]}ExchangeManager.usedPorts.push(ports.local);ExchangeManager.usedPorts.push(ports.remote);this.pc.connectDataConnection(ports.local,ports.remote)};ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type);sdp=new RTCSessionDescription(sdp);console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type);if(type==="OFFER"){self._makeAnswer()}},function(err){throw err;console.log("Failed to setRemoteDescription, ",err)})};ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate);console.log("Added ICE candidate.")};ExchangeManager.prototype.update=function(updates){var labels=Object.keys(updates);for(var i=0,ii=labels.length;i<ii;i+=1){var label=labels[i];this.labels[label]=updates[label]}};function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64){md5cycle(state,md5blk(s.substring(i-64,i)))}s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)}return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return a+b&4294967295}if(md5("hello")!="5d41402abc4b2a76b9719d911017c592"){function add32(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}}function ExchangeManager(id,peer,path,exchange,config,callback){var self=this;if(config.iceServers===undefined){config.iceServers=[{url:"stun:stun.l.google.com:19302"}]}if(config.protocol===undefined){config.protocol={offer:"OFFER",answer:"ANSWER",candidate:"CANDIDATE",port:"PORT"}}this.protocol=config.protocol;this._options=config;this.path=path;this._send=function(data){exchange.emit(data,peer,self.path)};this.id=id;this.peer=peer;this.pc=null;this.labels={};this._default=0;if(typeof callback=="function"){this.onpeerconnection=callback}else{this.onpeerconnection=function(pc,peer){}}if(!!this.id){this.initialize()}}ExchangeManager.prototype.ondata=function(data,path){if(path!==undefined){this.path=path.reverse()}switch(data.type){case this.protocol.offer:this.update(data.payload.labels);this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.answer:this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.candidate:this.handleCandidate(data.payload,data.type);break;case this.protocol.port:this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data);break}};ExchangeManager.prototype.initialize=function(id){if(!!id){this.id=id}this._startPeerConnection();this._setupIce();this._setupNegotiationHandler();this.initialize=function(){}};ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC");this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:true}]});this.onpeerconnection(this.pc,this.peer)};ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE");this.pc.onicecandidate=function(evt){if(evt.candidate){self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}}};ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer.");self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer.");self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){console.log("Failed to setLocalDescription from PEX, ",err)})},function(err){console.log("Failed to create answer, ",err)})};ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`");this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered");self._makeOffer()}};ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function setLocal(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer");console.log("Created offer.");self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}});self.labels={}},function handleError(err){console.log("Failed to setLocalDescription, ",err)})})};ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection.");if(!ExchangeManager.usedPorts){ExchangeManager.usedPorts=[]}ExchangeManager.usedPorts.push(ports.local);ExchangeManager.usedPorts.push(ports.remote);this.pc.connectDataConnection(ports.local,ports.remote)};ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type);sdp=new RTCSessionDescription(sdp);console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type);if(type==="OFFER"){self._makeAnswer()}},function(err){console.log("Failed to setRemoteDescription, ",err)})};ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate);console.log("Added ICE candidate.")};ExchangeManager.prototype.update=function(updates){var labels=Object.keys(updates);for(var i=0,ii=labels.length;i<ii;i+=1){var label=labels[i];this.labels[label]=updates[label]}};function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64){md5cycle(state,md5blk(s.substring(i-64,i)))}s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)}return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return a+b&4294967295}if(md5("hello")!="5d41402abc4b2a76b9719d911017c592"){function add32(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}}function ExchangeManager(id,peer,path,exchange,config,callback){var self=this;if(config.iceServers===undefined){config.iceServers=[{url:"stun:stun.l.google.com:19302"}]}if(config.protocol===undefined){config.protocol={offer:"OFFER",answer:"ANSWER",candidate:"CANDIDATE",port:"PORT"}}this.protocol=config.protocol;this._options=config;this.path=path;this._send=function(data){exchange.emit(data,peer,self.path)};this.id=id;this.peer=peer;this.pc=null;this.labels={};this._default=0;if(typeof callback=="function"){this.onpeerconnection=callback}else{this.onpeerconnection=function(pc,peer){}}if(!!this.id){this.initialize()}}ExchangeManager.prototype.ondata=function(data,path){if(path!==undefined){this.path=path.reverse()}switch(data.type){case this.protocol.offer:this.update(data.payload.labels);this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.answer:this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.candidate:this.handleCandidate(data.payload,data.type);break;case this.protocol.port:this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data);break}};ExchangeManager.prototype.initialize=function(id){if(!!id){this.id=id}this._startPeerConnection();this._setupIce();this._setupNegotiationHandler();this.initialize=function(){}};ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC");this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:true}]});this.onpeerconnection(this.pc,this.peer)};ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE");this.pc.onicecandidate=function(evt){if(evt.candidate){self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}}};ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer.");self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer.");self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){console.log("Failed to setLocalDescription from PEX, ",err)})},function(err){console.log("Failed to create answer, ",err)})};ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`");this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered");self._makeOffer()}};ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function setLocal(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer");console.log("Created offer.");self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}});self.labels={}},function handleError(err){console.log("Failed to setLocalDescription, ",err)})})};ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection.");if(!ExchangeManager.usedPorts){ExchangeManager.usedPorts=[]}ExchangeManager.usedPorts.push(ports.local);ExchangeManager.usedPorts.push(ports.remote);this.pc.connectDataConnection(ports.local,ports.remote)};ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type);sdp=new RTCSessionDescription(sdp);console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type);if(type==="OFFER"){self._makeAnswer()}},function(err){console.log("Failed to setRemoteDescription, ",err)})};ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate);console.log("Added ICE candidate.")};ExchangeManager.prototype.update=function(updates){var labels=Object.keys(updates);for(var i=0,ii=labels.length;i<ii;i+=1){var label=labels[i];this.labels[label]=updates[label]}};function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64){md5cycle(state,md5blk(s.substring(i-64,i)))}s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)}return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return a+b&4294967295}if(md5("hello")!="5d41402abc4b2a76b9719d911017c592"){function add32(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}}function ExchangeManager(id,peer,path,exchange,config,callback){var self=this;if(config.iceServers===undefined){config.iceServers=[{url:"stun:stun.l.google.com:19302"}]}if(config.protocol===undefined){config.protocol={offer:"OFFER",answer:"ANSWER",candidate:"CANDIDATE",port:"PORT"}}this.protocol=config.protocol;this._options=config;this.path=path;this._send=function(data){exchange.emit(data,peer,self.path)};this.id=id;this.peer=peer;this.pc=null;this.labels={};this._default=0;if(typeof callback=="function"){this.onpeerconnection=callback}else{this.onpeerconnection=function(pc,peer){}}if(!!this.id){this.initialize()}}ExchangeManager.prototype.ondata=function(data,path){if(path!==undefined){this.path=path.reverse()}switch(data.type){case this.protocol.offer:this.update(data.payload.labels);this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.answer:this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.candidate:this.handleCandidate(data.payload,data.type);break;case this.protocol.port:this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data);break}};ExchangeManager.prototype.initialize=function(id){if(!!id){this.id=id}this._startPeerConnection();this._setupIce();this._setupNegotiationHandler();this.initialize=function(){}};ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC");this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:true}]});this.onpeerconnection(this.pc,this.peer)};ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE");this.pc.onicecandidate=function(evt){if(evt.candidate){self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}}};ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer.");self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer.");self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){console.log("Failed to setLocalDescription from PEX, ",err)})},function(err){console.log("Failed to create answer, ",err)})};ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`");this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered");self._makeOffer()}};ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function setLocal(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer");console.log("Created offer.");self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}});self.labels={}},function handleError(err){console.log("Failed to setLocalDescription, ",err)})})};ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection.");if(!ExchangeManager.usedPorts){ExchangeManager.usedPorts=[]}ExchangeManager.usedPorts.push(ports.local);ExchangeManager.usedPorts.push(ports.remote);this.pc.connectDataConnection(ports.local,ports.remote)};ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type);sdp=new RTCSessionDescription(sdp);console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type);if(type==="OFFER"){self._makeAnswer()}},function(err){console.log("Failed to setRemoteDescription, ",err)})};ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate);console.log("Added ICE candidate.")};ExchangeManager.prototype.update=function(updates){var labels=Object.keys(updates);for(var i=0,ii=labels.length;i<ii;i+=1){var label=labels[i];this.labels[label]=updates[label]}};function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64){md5cycle(state,md5blk(s.substring(i-64,i)))}s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);
tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)}return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return a+b&4294967295}if(md5("hello")!="5d41402abc4b2a76b9719d911017c592"){function add32(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}}function ExchangeManager(id,peer,path,exchange,config,callback){var self=this;if(config.iceServers===undefined){config.iceServers=[{url:"stun:stun.l.google.com:19302"}]}if(config.protocol===undefined){config.protocol={offer:"OFFER",answer:"ANSWER",candidate:"CANDIDATE",port:"PORT"}}this.protocol=config.protocol;this._options=config;this.path=path;this._send=function(data){exchange.emit(data,peer,self.path)};this.id=id;this.peer=peer;this.pc=null;this.labels={};this._default=0;if(typeof callback=="function"){this.onpeerconnection=callback}else{this.onpeerconnection=function(pc,peer){}}if(!!this.id){this.initialize()}}ExchangeManager.prototype.ondata=function(data,path){if(path!==undefined){this.path=path.reverse()}switch(data.type){case this.protocol.offer:this.update(data.payload.labels);this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.answer:this.handleSDP(data.payload.sdp,data.type);break;case this.protocol.candidate:this.handleCandidate(data.payload,data.type);break;case this.protocol.port:this.handlePort(data.payload);break;default:console.log("got data I didn't know what to do with: ",data);break}};ExchangeManager.prototype.initialize=function(id){if(!!id){this.id=id}this._startPeerConnection();this._setupIce();this._setupNegotiationHandler();this.initialize=function(){}};ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC");this.pc=new RTCPeerConnection(this._options.config,{optional:[{RtpDataChannels:true}]});this.onpeerconnection(this.pc,this.peer)};ExchangeManager.prototype._setupIce=function(){var self=this;console.log("setting up ICE");this.pc.onicecandidate=function(evt){if(evt.candidate){self._send({type:"CANDIDATE",payload:{candidate:evt.candidate}})}}};ExchangeManager.prototype._makeAnswer=function(){var self=this;this.pc.createAnswer(function(answer){console.log("Created answer.");self.pc.setLocalDescription(answer,function(){console.log("Set localDescription to answer.");self._send({type:"ANSWER",payload:{sdp:answer}})},function(err){console.log("Failed to setLocalDescription from PEX, ",err)})},function(err){console.log("Failed to create answer, ",err)})};ExchangeManager.prototype._setupNegotiationHandler=function(){var self=this;console.log("Listening for `negotiationneeded`");this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered");self._makeOffer()}};ExchangeManager.prototype._makeOffer=function(){var self=this;this.pc.createOffer(function setLocal(offer){self.pc.setLocalDescription(offer,function(){console.log("Set localDescription to offer");console.log("Created offer.");self._send({type:"OFFER",payload:{sdp:offer,config:self._options.config,labels:self.labels}});self.labels={}},function handleError(err){console.log("Failed to setLocalDescription, ",err)})})};ExchangeManager.prototype.handlePort=function(ports){console.log("Received ports, calling connectDataConnection.");if(!ExchangeManager.usedPorts){ExchangeManager.usedPorts=[]}ExchangeManager.usedPorts.push(ports.local);ExchangeManager.usedPorts.push(ports.remote);this.pc.connectDataConnection(ports.local,ports.remote)};ExchangeManager.prototype.handleSDP=function(sdp,type){console.log("got "+type);sdp=new RTCSessionDescription(sdp);console.log(sdp);var self=this;this.pc.setRemoteDescription(sdp,function(){console.log("Set remoteDescription: "+type);if(type==="OFFER"){self._makeAnswer()}},function(err){console.log("Failed to setRemoteDescription, ",err)})};ExchangeManager.prototype.handleCandidate=function(message){var candidate=new RTCIceCandidate(message.candidate);this.pc.addIceCandidate(candidate);console.log("Added ICE candidate.")};ExchangeManager.prototype.update=function(updates){var labels=Object.keys(updates);for(var i=0,ii=labels.length;i<ii;i+=1){var label=labels[i];this.labels[label]=updates[label]}};function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64){md5cycle(state,md5blk(s.substring(i-64,i)))}s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)}return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return a+b&4294967295}if(md5("hello")!="5d41402abc4b2a76b9719d911017c592"){function add32(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}}