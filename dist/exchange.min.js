var Exchange=function(e){if(this.id=e,this.managers={},arguments.length>2){this.connections=arguments[2];for(var t in this.connections)this.addDC(this.connections[t],t)}else this.connections={};this.events={peer:new Array,peers:new Array},this.servers=[],this.queue=[],this.messages={}};Exchange.prototype._recieve=function(e){void 0===e.part?this.ondata(e):(void 0===this.messages[e.hash]&&(this.messages[e.hash]=new Array(e.length)),this.messages[e.hash][e.start]=e.part,console.log(this.messages),md5(this.messages[e.hash].join(""))==e.hash&&this.ondata(JSON.parse(this.messages[e.hash].join(""))))},Exchange.prototype._send=function(e,t){var o=this;console.log(o.connections[t]);var e;console.log("reliable"),e.exchange=!0,e=JSON.stringify(e),o.enqueue(e,t)},Exchange.prototype.enqueue=function(e,t){this.queue.push({peer:t,packet:e,attempts:0}),this.dequeue()},Exchange.max_attempts=10,Exchange.prototype.dequeue=function(){var e=this;if(this.queue.length>0){var t=this.queue.shift();if(t.attempts<Exchange.max_attempts)try{e.connections[t.peer].send(t.packet)}catch(o){t.attempts++,this.queue.push(t),this.dequeue()}}},Exchange.prototype.addDC=function(e,t){var o=this,s=e.onmessage,n=e.onerror,i=e.onclose;e.onmessage=function(e){var t=e.data;console.log("got",e);try{t=JSON.parse(t)}catch(n){if("function"!=typeof s)throw n;s(e)}void 0!==t.exchange?o._recieve(t):"function"==typeof s&&s(e)},e.onerror=function(e){console.log("ERROR: ",e),"function"==typeof n&&n(e)},e.onclose=function(e){o.connections[t]=null,delete o.connections[t],"function"==typeof i&&i(e)},o.connections[t]=e},Exchange.prototype.initWS=function(e,t){var o=this,s=new WebSocket(e);return s.onmessage=function(e){console.log(e);var s=JSON.parse(e.data);if(void 0!==s.peers)console.log("running peers"),console.log(s.peers),o.trigger("peers",s.peers);else{console.log(s);{({to:s[t.to],from:s[t.from],path:[],type:s[t.type],payload:s[t.payload],protocol:t})}s.type!=t.ignore&&o.ondata(JSON.parse(e.data))}},s.onclose=function(){},this.servers.push({socket:s,protocol:t}),s},Exchange.prototype.ondata=function(e){console.log("handeling",e),e.to!=this.id?this.forward(e):(-1==e.path.indexOf(this.id)&&e.path.push(this.id),void 0===this.managers[e.from]&&(this.managers[e.from]={}),void 0!==this.managers[e.from][e.label]?(console.log("our type",e.payload.type),this.managers[e.from][e.label].ondata(e.payload,e.path)):(console.log("our type",e.payload.type),console.log(this.id+" creating new manager for "+e.from),console.log("with label"+e.label),this.managers[e.from][e.label]=new ExchangeManager(this.id,e.from,e.path.reverse(),this,{},e.label),this.managers[e.from][e.label].ondata(e.payload),this.trigger("peer",this.managers[e.from][e.label])))},Exchange.prototype.forward=function(e){if(console.log("forwarding: ",e),void 0!==this.connections[e.to])-1==e.path.indexOf(this.id)&&e.path.push(this.id),this._send(e,e.to);else if(e.path.indexOf(this.id)+1==e.path.length||-1==e.path.indexOf(this.id)){-1==e.path.indexOf(this.id)&&e.path.push(this.id);for(var t in this.connections)-1==e.path.indexOf(t)&&this._send(e,t)}else if(e.path.indexOf(this.id)>-1){var o=e.path[e.path.indexOf(this.id)+1];console.log(o),this._send(e,o)}},Exchange.prototype.reliable=function(e,t,o,s,n){var i={path:o,from:this.id,to:s,payload:e,label:n};this._send(i,t)},Exchange.prototype.emit=function(e,t,o,s){if(console.log("emit",e.type),o.indexOf(t)+1==o.length&&-1==o.indexOf(this.id)&&o.unshift(this.id),void 0!==this.connections[t])-1==o.indexOf(this.id)&&o.push(this.id),console.log("emit",e.type),this.reliable(e,t,o,t,s);else if(o.indexOf(this.id)+1==o.length||-1==o.indexOf(this.id)){-1==o.indexOf(this.id)&&o.push(this.id);for(var n in this.connections)console.log(this.connections),-1==o.indexOf(n)&&this.reliable(e,n,[],t,s);for(var i=0;i<this.servers.length;i++){var a=this.servers[i];if(1==a.socket.readyState){var h={};h[a.protocol.to]=t,h[a.protocol.from]=this.id,h.path=[],h.label=s,h.payload=e,a.socket.send(JSON.stringify(h))}}}else if(o.indexOf(this.id)>-1){var r=o.indexOf(this.id)+1;this.reliable(e,o[r],o,t,s)}},Exchange.prototype.on=function(e,t){try{this.events[e].push(t)}catch(o){throw{message:e+" event doesn't exists",name:"EventException"}}},Exchange.prototype.trigger=function(e){for(var t in this.events[e])this.events[e][t].apply(this,arguments)},Exchange.prototype.connect=function(e,t){return console.log("connecting to ",e),void 0==t&&(t="base"),void 0===this.managers[e]&&(this.managers[e]={}),console.log("label ",t),this.managers[e][t]=new ExchangeManager(this.id,e,[],this,{},t),this.managers[e][t]};
function ExchangeManager(e,o,n,t,a,i){var c=this;void 0===a.iceServers&&(a.iceServers=[{url:"stun:stun.l.google.com:19302"}]),void 0===a.protocol&&(a.protocol={offer:"OFFER",answer:"ANSWER",candidate:"CANDIDATE",port:"PORT"}),this.protocol=a.protocol,this._options=a,this.path=n,this._send=function(e){console.log(i),t.emit(e,o,c.path,i)},this.id=e,this.peer=o,this.pc=null,this.exchange=t,this.labels={},this._default=0,this._startPeerConnection()}var RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,RTCIceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate;ExchangeManager.prototype.ondata=function(e,o){var n=this;switch(void 0!==o&&(this.path=o.reverse()),e.type){case this.protocol.offer:console.log("got offer"),n._setupIce(),n.update(e.payload.labels),n.handleSDP(e.payload.sdp,e.type);break;case this.protocol.answer:console.log("got answer"),this.handleSDP(e.payload.sdp,e.type);break;case this.protocol.candidate:this.handleCandidate(e.payload,e.type);break;case this.protocol.port:this.handlePort(e.payload);break;default:console.log("got data I didn't know what to do with: ",e)}},ExchangeManager.prototype.initialize=function(e){e&&(this.id=e),this._setupIce(),this._setupNegotiationHandler(),this.initialize=function(){}},ExchangeManager.prototype.createDataChannel=function(e,o){var n=this.pc.createDataChannel(e,o);return this.initialize(),n},ExchangeManager.prototype._startPeerConnection=function(){console.log("starting PC"),this.pc=new RTCPeerConnection(this._options,{optional:[{RtpDataChannels:!0},{DtlsSrtpKeyAgreement:!0}]})},ExchangeManager.prototype._setupIce=function(){var e=this;console.log("setting up ICE"),this.pc.onicecandidate=function(o){o.candidate&&(console.log(o.candidate),e._send({type:"CANDIDATE",payload:{candidate:o.candidate}}))}},ExchangeManager.prototype._makeAnswer=function(){var e=this;this.pc.createAnswer(function(o){console.log("Created answer."),e.pc.setLocalDescription(o,function(){console.log("Set localDescription to answer."),e._send({type:"ANSWER",payload:{sdp:o}})},function(e){console.log("Failed to setLocalDescription from PEX, ",e)})},function(e){console.log("Failed to create answer, ",e)})},ExchangeManager.prototype._setupNegotiationHandler=function(){var e=this;void 0!==window.webkitRTCPeerConnection?(console.log("Listening for `negotiationneeded`"),this.pc.onnegotiationneeded=function(){console.log("`negotiationneeded` triggered"),e._makeOffer()}):e._makeOffer()},ExchangeManager.prototype._makeOffer=function(){var e=this;this.pc.createOffer(function(o){console.log("Set localDescription to",o),e.pc.setLocalDescription(o,function(){console.log("Set localDescription to",o),e._send({type:"OFFER",payload:{sdp:o,config:e._options.config,labels:e.labels}})},function(e){console.log("Failed to setLocalDescription, ",e)})},function(e){console.log("Failed to create offer, ",e)},{optional:[],mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}})},ExchangeManager.prototype.handlePort=function(e){console.log("Received ports, calling connectDataConnection."),ExchangeManager.usedPorts||(ExchangeManager.usedPorts=[]),ExchangeManager.usedPorts.push(e.local),ExchangeManager.usedPorts.push(e.remote),this.pc.connectDataConnection(e.local,e.remote)},ExchangeManager.prototype.handleSDP=function(e,o){console.log("got "+o),e=new RTCSessionDescription(e),console.log(e);var n=this;this.pc.setRemoteDescription(e,function(){console.log("Set remoteDescription: "+o),"OFFER"===o&&n._makeAnswer()},function(e){console.log("Failed to setRemoteDescription, ",e)})},ExchangeManager.prototype.handleCandidate=function(e){console.log(e);var o=new RTCIceCandidate(e.candidate);this.pc.addIceCandidate(o),console.log("Added ICE candidate.")},ExchangeManager.prototype.update=function(e){for(var o=Object.keys(e),n=0,t=o.length;t>n;n+=1){var a=o[n];this.labels[a]=e[a]}};
function md5cycle(f,h){var i=f[0],n=f[1],r=f[2],g=f[3];i=ff(i,n,r,g,h[0],7,-680876936),g=ff(g,i,n,r,h[1],12,-389564586),r=ff(r,g,i,n,h[2],17,606105819),n=ff(n,r,g,i,h[3],22,-1044525330),i=ff(i,n,r,g,h[4],7,-176418897),g=ff(g,i,n,r,h[5],12,1200080426),r=ff(r,g,i,n,h[6],17,-1473231341),n=ff(n,r,g,i,h[7],22,-45705983),i=ff(i,n,r,g,h[8],7,1770035416),g=ff(g,i,n,r,h[9],12,-1958414417),r=ff(r,g,i,n,h[10],17,-42063),n=ff(n,r,g,i,h[11],22,-1990404162),i=ff(i,n,r,g,h[12],7,1804603682),g=ff(g,i,n,r,h[13],12,-40341101),r=ff(r,g,i,n,h[14],17,-1502002290),n=ff(n,r,g,i,h[15],22,1236535329),i=gg(i,n,r,g,h[1],5,-165796510),g=gg(g,i,n,r,h[6],9,-1069501632),r=gg(r,g,i,n,h[11],14,643717713),n=gg(n,r,g,i,h[0],20,-373897302),i=gg(i,n,r,g,h[5],5,-701558691),g=gg(g,i,n,r,h[10],9,38016083),r=gg(r,g,i,n,h[15],14,-660478335),n=gg(n,r,g,i,h[4],20,-405537848),i=gg(i,n,r,g,h[9],5,568446438),g=gg(g,i,n,r,h[14],9,-1019803690),r=gg(r,g,i,n,h[3],14,-187363961),n=gg(n,r,g,i,h[8],20,1163531501),i=gg(i,n,r,g,h[13],5,-1444681467),g=gg(g,i,n,r,h[2],9,-51403784),r=gg(r,g,i,n,h[7],14,1735328473),n=gg(n,r,g,i,h[12],20,-1926607734),i=hh(i,n,r,g,h[5],4,-378558),g=hh(g,i,n,r,h[8],11,-2022574463),r=hh(r,g,i,n,h[11],16,1839030562),n=hh(n,r,g,i,h[14],23,-35309556),i=hh(i,n,r,g,h[1],4,-1530992060),g=hh(g,i,n,r,h[4],11,1272893353),r=hh(r,g,i,n,h[7],16,-155497632),n=hh(n,r,g,i,h[10],23,-1094730640),i=hh(i,n,r,g,h[13],4,681279174),g=hh(g,i,n,r,h[0],11,-358537222),r=hh(r,g,i,n,h[3],16,-722521979),n=hh(n,r,g,i,h[6],23,76029189),i=hh(i,n,r,g,h[9],4,-640364487),g=hh(g,i,n,r,h[12],11,-421815835),r=hh(r,g,i,n,h[15],16,530742520),n=hh(n,r,g,i,h[2],23,-995338651),i=ii(i,n,r,g,h[0],6,-198630844),g=ii(g,i,n,r,h[7],10,1126891415),r=ii(r,g,i,n,h[14],15,-1416354905),n=ii(n,r,g,i,h[5],21,-57434055),i=ii(i,n,r,g,h[12],6,1700485571),g=ii(g,i,n,r,h[3],10,-1894986606),r=ii(r,g,i,n,h[10],15,-1051523),n=ii(n,r,g,i,h[1],21,-2054922799),i=ii(i,n,r,g,h[8],6,1873313359),g=ii(g,i,n,r,h[15],10,-30611744),r=ii(r,g,i,n,h[6],15,-1560198380),n=ii(n,r,g,i,h[13],21,1309151649),i=ii(i,n,r,g,h[4],6,-145523070),g=ii(g,i,n,r,h[11],10,-1120210379),r=ii(r,g,i,n,h[2],15,718787259),n=ii(n,r,g,i,h[9],21,-343485551),f[0]=add32(i,f[0]),f[1]=add32(n,f[1]),f[2]=add32(r,f[2]),f[3]=add32(g,f[3])}function cmn(f,h,i,n,r,g){return h=add32(add32(h,f),add32(n,g)),add32(h<<r|h>>>32-r,i)}function ff(f,h,i,n,r,g,t){return cmn(h&i|~h&n,f,h,r,g,t)}function gg(f,h,i,n,r,g,t){return cmn(h&n|i&~n,f,h,r,g,t)}function hh(f,h,i,n,r,g,t){return cmn(h^i^n,f,h,r,g,t)}function ii(f,h,i,n,r,g,t){return cmn(i^(h|~n),f,h,r,g,t)}function md51(f){txt="";var h,i=f.length,n=[1732584193,-271733879,-1732584194,271733878];for(h=64;h<=f.length;h+=64)md5cycle(n,md5blk(f.substring(h-64,h)));f=f.substring(h-64);var r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(h=0;h<f.length;h++)r[h>>2]|=f.charCodeAt(h)<<(h%4<<3);if(r[h>>2]|=128<<(h%4<<3),h>55)for(md5cycle(n,r),h=0;16>h;h++)r[h]=0;return r[14]=8*i,md5cycle(n,r),n}function md5blk(f){var h,i=[];for(h=0;64>h;h+=4)i[h>>2]=f.charCodeAt(h)+(f.charCodeAt(h+1)<<8)+(f.charCodeAt(h+2)<<16)+(f.charCodeAt(h+3)<<24);return i}function rhex(f){for(var h="",i=0;4>i;i++)h+=hex_chr[f>>8*i+4&15]+hex_chr[f>>8*i&15];return h}function hex(f){for(var h=0;h<f.length;h++)f[h]=rhex(f[h]);return f.join("")}function md5(f){return hex(md51(f))}function add32(f,h){return f+h&4294967295}function add32(f,h){var i=(65535&f)+(65535&h),n=(f>>16)+(h>>16)+(i>>16);return n<<16|65535&i}var hex_chr="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=md5("hello");