<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Exchange Demo</title>
    <script src="../../exchange_manager.js"></script>
    <script src="../../exchange.js"></script>
    <script src="../../md5.js"></script>
    <script type="text/javascript" src="../bower_components/angular/angular.js"></script>
</head>
<body ng-app="exchangeDemo">
  <div style="z-index:9999; position:absolute" ng-controller="demo">
    {{peers}}
    <div ng-repeat="connection in connections">{{connection | json : object}}</div>
  </div>



  <script>
    navigator.getUserMedia = ( navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);

    var myApp = angular.module('exchangeDemo',[]);

    myApp.controller('demo', ['$scope', function($scope) {

      var host = 'relay.whytheplatypus.technology'
          ,port = 80;

      var protocol = {
          to: 'to',
          from: 'from',
          type: 'type',
          payload: 'payload',
          ignore: '',
          offer: 'OFFER',
          answer: 'ANSWER',
          candidate: 'CANDIDATE',
          port: 'PORT'
      };

      $scope.peers = 0;
      var local_stream = false;

navigator.getUserMedia({video: true, audio:true}, function(stream) {
        // manager.pc.onaddstream({stream: stream});
        // Adding a local stream won't trigger the onaddstream callback
        // pc.addStream(stream)
        local_stream = stream;
        var video = document.createElement("video");
        document.body.appendChild(video);
        video.src = window.URL.createObjectURL(stream);
        video.play();
        video.muted;


      var me = new Exchange(Math.random().toString(36).substr(2));
      $scope.connections = [];
      var peerjsServer = 'ws://' + host + ':' + port + '/?id='+me.id;
      me.on('peers', function(eventname, peers){
        console.log("peers", peers);
        for(var i = 0; i < peers.length; i++){
          var peer = peers[i];
          console.log("peer: ",peer);
          var manager = me.connect(peer);


          // addPeer(manager.createVideoChannel(manager.peer, {reliable : true, protocol: "draw"}));
          manager.pc.onaddstream = function(obj) {
            console.log("test");
            var video = document.createElement("video");
            document.body.appendChild(video);
            video.src = window.URL.createObjectURL(obj.stream);
            video.play();

          }

          manager.createVideoChannel(local_stream);
        }
      });

      me.on('peer', function(eventName, peerManager){
        console.log("got connection")
        var manager = peerManager;
        manager.pc.onaddstream = function(obj) {
          var video = document.createElement("video");
          document.body.appendChild(video);
          video.src = window.URL.createObjectURL(obj.stream);
          video.play();
        }
        manager.pc.addStream(local_stream);

        // navigator.getUserMedia({video: true}, function(stream) {
        //   manager.pc.onaddstream({stream: stream});
        //   // Adding a local stream won't trigger the onaddstream callback
        //   // pc.addStream(stream)
        //   manager.createVideoChannel(stream);
        // }, function(err){console.log(err);});
      });



      me.initWS(peerjsServer, protocol);
}, function(err){console.log(err);});

    }]);
  </script>
</body>
</html>
